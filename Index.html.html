<!doctype html>
<html lang="pt-BR" class="h-full">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Planner de Estudos (TRT) ‚Äî Port√°til</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
    :root{
      --bg: #f0f9ff;
      --bg2:#e0f2fe;
      --card:#ffffff;
      --border: rgba(14,165,233,.22);
      --border2: rgba(14,165,233,.14);
      --text: #0f172a;
      --muted:#475569;
      --primary:#0284c7;
      --primary2:#0ea5e9;
      --shadow: 0 10px 30px rgba(2,132,199,.10);
      --shadow2: 0 6px 16px rgba(2,132,199,.10);
      --radius: 18px;
      --radius2: 22px;
      --ring: 0 0 0 4px rgba(14,165,233,.18);
    }
    body { box-sizing: border-box; }
    * { font-family: 'Space Grotesk', sans-serif; }

    body{
      background:
        radial-gradient(900px 380px at 10% 0%, rgba(14,165,233,.18), transparent 60%),
        radial-gradient(900px 380px at 90% 0%, rgba(34,211,238,.16), transparent 60%),
        radial-gradient(700px 420px at 50% 110%, rgba(56,189,248,.12), transparent 60%),
        var(--bg);
    }
    .scrollbar-thin::-webkit-scrollbar { width: 10px; height: 10px; }
    .scrollbar-thin::-webkit-scrollbar-track { background: transparent; }
    .scrollbar-thin::-webkit-scrollbar-thumb { background: rgba(2,132,199,.25); border-radius: 999px; border: 2px solid rgba(255,255,255,.6); }
    .scrollbar-thin::-webkit-scrollbar-thumb:hover { background: rgba(2,132,199,.45); }

    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    .animate-fade { animation: fadeIn 0.25s ease-out; }

    .app-shell { max-width: 1200px; margin: 0 auto; }
    .app-card { border-radius: var(--radius2); box-shadow: var(--shadow2); border: 1px solid var(--border2); transition: box-shadow .12s ease; }
    .app-card:hover { box-shadow: var(--shadow); }
    .glass { background: rgba(255,255,255,.75); backdrop-filter: blur(12px); }

    .chip { display:inline-flex; align-items:center; gap:.4rem; padding:.25rem .6rem; border-radius:999px; background: rgba(2,132,199,.10); border:1px solid rgba(2,132,199,.18); }

    .btn { display:inline-flex; align-items:center; justify-content:center; gap:.5rem; padding:.6rem 1rem; border-radius: 14px; font-weight:600; font-size:.9rem; transition: transform .12s ease, box-shadow .12s ease, background .12s ease, color .12s ease, border-color .12s ease; user-select:none; }
    .btn:active{ transform: translateY(1px); }
    .btn-primary{ background: var(--primary); color:#fff; box-shadow: 0 10px 20px rgba(2,132,199,.18); }
    .btn-primary:hover{ background: #0369a1; }
    .btn-secondary{ background: #fff; border:1px solid rgba(14,165,233,.28); color:#0f172a; }
    .btn-secondary:hover{ background: rgba(240,249,255,.8); }
    .btn-danger{ background:#dc2626; color:#fff; }
    .btn-danger:hover{ background:#b91c1c; }

    input, textarea, select { outline:none; }
    input:focus, textarea:focus, select:focus { box-shadow: var(--ring); border-color: rgba(14,165,233,.55)!important; }

    .tab-btn { border-radius: 14px; transition: transform .12s ease; }
    .tab-btn:hover { transform: translateY(-1px); }

    .hairline { border-top:1px solid rgba(2,132,199,.12); }

    /* ‚ÄúApp feel‚Äù: micro-intera√ß√µes e hierarquia */
    .lift { transition: transform .18s ease, box-shadow .18s ease, background-color .18s ease, border-color .18s ease; }
    .lift:hover { transform: translateY(-2px); box-shadow: 0 18px 30px rgba(2,132,199,.10); }
    .pill { display:inline-flex; align-items:center; gap:.45rem; padding:.28rem .65rem; border-radius:999px; background: rgba(255,255,255,.78); border:1px solid rgba(14,165,233,.22); box-shadow: 0 10px 20px rgba(2,132,199,.08); }
    .pill-dot { width:8px; height:8px; border-radius:999px; background: rgba(2,132,199,.85); }
    .kbd { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; font-size:.75rem; padding:.15rem .4rem; border-radius:.5rem; border:1px solid rgba(14,165,233,.25); background: rgba(255,255,255,.7); }
    .fab { position: fixed; right: 18px; bottom: 18px; z-index: 60; }
    .fab-btn { width: 54px; height: 54px; border-radius: 18px; box-shadow: 0 18px 40px rgba(2,132,199,.22); }
    .coach { position: fixed; left: 18px; bottom: 18px; z-index: 60; }
  

/* components */
.btn{display:inline-flex;align-items:center;justify-content:center;gap:.5rem;border-radius:var(--radius-sm);padding:.55rem .9rem;font-weight:600;letter-spacing:.01em;transition:transform .08s ease, box-shadow .18s ease, background-color .18s ease, border-color .18s ease, color .18s ease;user-select:none}
.btn:active{transform:translateY(1px)}
.btn:focus{outline:none}
.btn:focus-visible{box-shadow:var(--ring)}
.btn-primary{background:var(--primary);color:#fff;box-shadow:0 10px 22px rgba(2,132,199,.25)}
.btn-primary:hover{background:var(--primary2)}
.btn-secondary{background:rgba(255,255,255,.92);border:1px solid var(--border);color:var(--text)}
.btn-secondary:hover{background:rgba(240,249,255,.8);border-color:rgba(2,132,199,.25)}
.btn-ghost{background:transparent;border:1px solid transparent;color:var(--muted)}
.btn-ghost:hover{background:rgba(2,132,199,.06);color:var(--text)}
.btn-danger{background:rgba(244,63,94,.08);border:1px solid rgba(244,63,94,.25);color:#be123c}
.btn-danger:hover{background:rgba(244,63,94,.12)}
.btn-xs{padding:.35rem .6rem;border-radius:12px}
.btn-lg{padding:.7rem 1.05rem;border-radius:14px}
.btn-xl{padding:.85rem 1.2rem;border-radius:16px}

.btn-fab{width:3rem;height:3rem;border-radius:18px;background:var(--primary);color:#fff;display:flex;align-items:center;justify-content:center;box-shadow:0 18px 35px rgba(2,132,199,.35);transition:transform .08s ease, box-shadow .18s ease, background-color .18s ease}
.btn-fab:hover{background:var(--primary2)}
.btn-fab:focus-visible{box-shadow:var(--ring),0 18px 35px rgba(2,132,199,.35)}

.input{width:100%;background:rgba(255,255,255,.9);border:1px solid var(--border);border-radius:14px;padding:.65rem .8rem;color:var(--text);transition:border-color .18s ease, box-shadow .18s ease, background-color .18s ease}
.input:focus{outline:none}
.input:focus-visible{box-shadow:var(--ring);border-color:rgba(2,132,199,.45)}
.textarea{min-height:120px;resize:vertical}
.label{font-size:.78rem;color:var(--muted);font-weight:650;letter-spacing:.02em;text-transform:uppercase}
.card{background:rgba(255,255,255,.88);border:1px solid rgba(2,132,199,.12);border-radius:22px;box-shadow:var(--shadow);backdrop-filter: blur(8px)}
.chip{display:inline-flex;align-items:center;gap:.35rem;border-radius:999px;padding:.35rem .7rem;border:1px solid rgba(2,132,199,.15);background:rgba(2,132,199,.06);color:var(--text);font-size:.8rem}

</style>
</head>

<body class="h-full text-slate-900 overflow-hidden">
  <div id="app" class="h-full w-full flex flex-col overflow-hidden">
    <div class="app-shell h-full w-full flex flex-col overflow-hidden px-3 md:px-6">
    <!-- Header -->
    <header class="glass border-b border-sky-200/70 px-4 md:px-5 py-3.5 flex items-center justify-between shrink-0 rounded-b-2xl shadow-[0_8px_24px_rgba(2,132,199,.10)] mt-3">
      <div class="flex items-center gap-3">
        <div class="w-10 h-10 bg-gradient-to-br from-sky-500 to-cyan-500 rounded-xl flex items-center justify-center shadow-sm">
          <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
              d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253" />
          </svg>
        </div>
        <div>
          <h1 id="app-title" class="text-lg font-bold text-slate-900">Planner de Estudos</h1>
          <p id="welcome-msg" class="text-xs text-slate-600">Bons estudos!</p>
        </div>
      </div>

      <!-- Mini Timer -->
      <div class="flex items-center gap-2">
        <!-- Micro-m√©tricas (reduz carga cognitiva) -->
        <div id="header-stats" class="hidden md:flex items-center gap-2"></div>

        <!-- Mini Timer -->
        <div id="mini-timer" class="hidden items-center gap-2 bg-white/80 backdrop-blur border border-sky-200/70 px-3 py-1.5 rounded-xl cursor-pointer hover:bg-white transition shadow-[0_10px_20px_rgba(2,132,199,.10)]" onclick="showTab('cronometro')">
          <span id="mini-timer-display" class="font-mono text-sky-700 font-semibold">00:00</span>
          <div class="w-2 h-2 bg-sky-500 rounded-full animate-pulse"></div>
        </div>
      </div>
    </header>

        <!-- Tabs -->
    <nav class="glass border-b border-sky-200/70 px-2 py-2.5 shrink-0 rounded-2xl mt-3 shadow-[0_6px_16px_rgba(2,132,199,.08)]">
      <div class="relative">
        <!-- fade edges -->
        <div class="pointer-events-none absolute left-0 top-0 h-full w-10 bg-gradient-to-r from-white/90 to-transparent rounded-l-2xl"></div>
        <div class="pointer-events-none absolute right-0 top-0 h-full w-10 bg-gradient-to-l from-white/90 to-transparent rounded-r-2xl"></div>

        <!-- scroll buttons -->
        <button type="button" aria-label="Voltar" onclick="scrollTabs(-260)"
          class="absolute left-1 top-1/2 -translate-y-1/2 z-10 hidden md:flex items-center justify-center w-8 h-8 rounded-xl bg-white/80 hover:bg-white border border-sky-200/70 text-slate-600 hover:text-slate-900 shadow-[0_10px_20px_rgba(2,132,199,.10)] transition">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/></svg>
        </button>
        <button type="button" aria-label="Avan√ßar" onclick="scrollTabs(260)"
          class="absolute right-1 top-1/2 -translate-y-1/2 z-10 hidden md:flex items-center justify-center w-8 h-8 rounded-xl bg-white/80 hover:bg-white border border-sky-200/70 text-slate-600 hover:text-slate-900 shadow-[0_10px_20px_rgba(2,132,199,.10)] transition">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/></svg>
        </button>

        <div id="tabs-scroll" class="overflow-x-auto scrollbar-thin px-9 md:px-10">
          <div id="tabs" class="flex gap-1.5 min-w-max"></div>
        </div>
      </div>
    </nav>

    <!-- Main -->
    <main class="flex-1 overflow-y-auto scrollbar-thin p-4 md:p-6">
      <div id="tab-root" class="animate-fade"></div>
    </main>

    </div>

    <!-- Toast -->
    <div id="toast" class="fixed bottom-4 right-4 z-50 space-y-2"></div>

    <!-- A√ß√£o r√°pida (FAB) -->
    <button id="fab" class="fixed bottom-5 left-5 md:left-auto md:right-5 z-40 btn-fab lift" title="A√ß√µes r√°pidas (atalho: Ctrl+K)">
      <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 5v14"/><path d="M5 12h14"/></svg>
    </button>

    <!-- ‚ÄúCoach‚Äù discreto (dicas contextuais) -->
    <div id="coach" class="fixed bottom-5 right-5 md:bottom-5 md:right-20 z-40 hidden">
      <div class="bg-white/90 backdrop-blur border border-sky-200/70 rounded-2xl shadow-[0_18px_35px_rgba(2,132,199,.14)] p-3 w-72">
        <div class="flex items-start justify-between gap-2">
          <div>
            <div class="text-sm font-semibold text-slate-800">Dica r√°pida</div>
            <div id="coach-text" class="text-xs text-slate-600 mt-1">.</div>
          </div>
          <button id="coach-close" class="text-slate-400 hover:text-slate-700" title="Fechar">
            <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 6 6 18"/><path d="M6 6l12 12"/></svg>
          </button>
        </div>
        <div class="mt-2 flex gap-2">
          <button id="coach-action" class="btn btn-primary btn-xs lift">Fazer agora</button>
          <button id="coach-later" class="px-3 py-1.5 rounded-xl bg-white hover:bg-sky-50 border border-sky-200 text-slate-700 text-xs lift">Depois</button>
        </div>
      </div>
    </div>

    <!-- Modal -->
    <div id="modal" class="fixed inset-0 bg-slate-900/30 backdrop-blur-sm z-50 hidden items-center justify-center p-4">
      <div class="bg-white rounded-2xl p-6 max-w-lg w-full border border-sky-200 shadow-[0_20px_50px_rgba(2,132,199,.18)]">
        <div class="flex items-center justify-between gap-4 mb-2">
          <h3 id="modal-title" class="text-lg font-semibold text-slate-900">Modal</h3>
          <button onclick="closeModal()" class="text-slate-500 hover:text-slate-900 transition">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
            </svg>
          </button>
        </div>
        <div id="modal-body" class="text-slate-700 whitespace-pre-wrap text-sm max-h-[60vh] overflow-y-auto scrollbar-thin"></div>
        <div id="modal-actions" class="mt-5 flex gap-2 justify-end"></div>
      </div>
    </div>
  </div>


<script>
/* =========================
   StudyOS MultiUser PRO (offline)
   Base UI/Theme: v40 components
   ========================= */

// ---------- Utils ----------
const $ = (sel, el=document)=>el.querySelector(sel);
const $$ = (sel, el=document)=>Array.from(el.querySelectorAll(sel));
const uid = (p="id") => p + "_" + Math.random().toString(36).slice(2,10);
const clamp = (n,a,b)=>Math.max(a,Math.min(b,n));
const nowIso = ()=>new Date().toISOString();
const todayISO = ()=>{
  const d = new Date();
  const y = d.getFullYear();
  const m = String(d.getMonth()+1).padStart(2,"0");
  const day = String(d.getDate()).padStart(2,"0");
  return `${y}-${m}-${day}`;
};
function addDaysISO(iso, n){
  const d = new Date(iso+"T00:00:00");
  d.setDate(d.getDate()+n);
  return d.toISOString().slice(0,10);
}
const escapeHtml = (s)=>String(s??"").replace(/[&<>"']/g, c=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;" }[c]));

// ---------- Toast ----------
function toast(msg, tone="info"){
  const t = $("#toast");
  if(!t) return alert(msg);
  const toneCls = tone==="danger" ? "bg-rose-600" : (tone==="ok" ? "bg-emerald-600" : "bg-slate-900");
  const html = `
    <div class="flex items-start gap-3 ${toneCls} text-white px-4 py-3 rounded-2xl shadow-[0_14px_30px_rgba(0,0,0,.18)] border border-white/10 animate-fade">
      <div class="w-2.5 h-2.5 mt-1.5 rounded-full bg-white/90"></div>
      <div class="text-sm leading-snug">${escapeHtml(msg)}</div>
    </div>
  `;
  t.innerHTML = html;
  clearTimeout(window.__toastTimer);
  window.__toastTimer = setTimeout(()=>{ t.innerHTML=""; }, 2400);
}

// ---------- Modal ----------
function openModal(title, body, actions=[]){
  $("#modal-title").textContent = title || "Modal";
  $("#modal-body").innerHTML = body || "";
  const act = $("#modal-actions");
  act.innerHTML = "";
  actions.forEach(a=>{
    const b = document.createElement("button");
    b.className = a.className || "px-3 py-2 rounded-xl bg-slate-900 text-white text-sm lift";
    b.textContent = a.label || "OK";
    b.onclick = ()=>{ if(a.onClick) a.onClick(); };
    act.appendChild(b);
  });
  $("#modal").classList.remove("hidden");
  $("#modal").classList.add("flex");
}
function closeModal(){
  $("#modal").classList.add("hidden");
  $("#modal").classList.remove("flex");
}

// ---------- Storage (MultiUser) ----------
const STORAGE_KEY = "studyos_multiuser_pro_v1";
function loadState(){
  try{
    const raw = localStorage.getItem(STORAGE_KEY);
    if(!raw) return null;
    return JSON.parse(raw);
  }catch(e){ console.warn(e); return null; }
}
function saveState(st){
  localStorage.setItem(STORAGE_KEY, JSON.stringify(st));
}
function defaultState(){
  return {
    version: 1,
    activeUserId: null,
    users: {}
  };
}
function makeUser(name){
  return {
    id: uid("u"),
    name: name || "Usu√°rio",
    startDate: todayISO(),
    examId: "trt_analista",
    weeklyGoalMin: 1800,
    logs: [],
    tasks: {}, // id -> {date, subject, topic, minutes, status}
    notes: [],
    errors: [],
    coach: { stats:{}, history:[], lastSuggestionId:null },
    prefs: { nbMode:"Anota√ß√µes", nbQuery:"", revFilter:"DUE" }
  };
}

// ---------- Exams / Curricula (BETA - pode expandir) ----------
const EXAMS = {
  trt_analista: {
    name: "Analista Judici√°rio (TRT)",
    subjects: [
      { name:"Direito Constitucional", topics:["Constitui√ß√£o: conceito/classifica√ß√µes","Direitos e garantias fundamentais","Controle de constitucionalidade","Poder Judici√°rio e fun√ß√µes essenciais","Processo legislativo e compet√™ncias"]},
      { name:"Direito Administrativo", topics:["Administra√ß√£o P√∫blica e princ√≠pios","Atos administrativos","Poderes da Administra√ß√£o","Organiza√ß√£o administrativa","Agentes p√∫blicos","Responsabilidade civil do Estado"]},
      { name:"Direito do Trabalho", topics:["Rela√ß√£o de emprego","Contrato de trabalho","Jornada e descanso","Remunera√ß√£o","Rescis√£o","Estabilidade","Sindicatos e greve","Direitos coletivos"]},
      { name:"Processo do Trabalho", topics:["Compet√™ncia JT","Procedimentos","Audi√™ncia e provas","Recursos","Execu√ß√£o trabalhista","Liquida√ß√£o","S√∫mulas/OJs TST"]},
      { name:"Portugu√™s", topics:["Interpreta√ß√£o","Pontua√ß√£o","Concord√¢ncia","Reg√™ncia/Crase","Coes√£o e coer√™ncia","Classes de palavras"]},
      { name:"RLM/Matem√°tica", topics:["Proposi√ß√µes","Conjuntos","Porcentagem","Probabilidade","Sequ√™ncias","An√°lise combinat√≥ria"]},
      { name:"Inform√°tica", topics:["Windows/Office","Internet e seguran√ßa","Atalhos e produtividade","No√ß√µes de redes","LGPD (no√ß√µes)"]},
      { name:"Jurisprud√™ncia", topics:["STF: temas recorrentes","TST: s√∫mulas quentes","Informativos e teses","Compet√™ncia e processo","Direitos fundamentais no trabalho"]}
    ]
  },
  receita_auditor: {
    name:"Auditor-Fiscal (Receita Federal)",
    subjects:[
      {name:"Portugu√™s", topics:["Interpreta√ß√£o","Gram√°tica aplicada","Reescrita","Pontua√ß√£o","Crase/reg√™ncia"]},
      {name:"RLM/Estat√≠stica", topics:["Probabilidade","Estat√≠stica descritiva","Distribui√ß√µes","Amostragem","Racioc√≠nio l√≥gico"]},
      {name:"Direito Constitucional", topics:["Direitos fundamentais","Administra√ß√£o p√∫blica","Tributa√ß√£o na CF","Controle de constitucionalidade"]},
      {name:"Direito Administrativo", topics:["Atos/poderes","Licita√ß√µes (no√ß√µes)","Agentes p√∫blicos","Responsabilidade do Estado"]},
      {name:"Direito Tribut√°rio", topics:["Esp√©cies tribut√°rias","Obriga√ß√£o tribut√°ria","Cr√©dito tribut√°rio","Lan√ßamento","Imunidades/isen√ß√µes","Processo administrativo fiscal (no√ß√µes)"]},
      {name:"Legisla√ß√£o Aduaneira", topics:["Importa√ß√£o/Exporta√ß√£o (no√ß√µes)","Regimes aduaneiros","Infra√ß√µes e penalidades","Despacho aduaneiro"]},
      {name:"Contabilidade", topics:["Princ√≠pios","Balan√ßo","DRE","Lan√ßamentos","An√°lise de demonstra√ß√µes","Custos (no√ß√µes)"]},
      {name:"Com√©rcio Internacional", topics:["INCOTERMS (no√ß√µes)","Organismos","Pol√≠tica comercial","Balan√ßo de pagamentos"]},
    ]
  },
  inss_analista: {
    name:"Analista do INSS",
    subjects:[
      {name:"Portugu√™s", topics:["Interpreta√ß√£o","Gram√°tica","Reda√ß√£o oficial (no√ß√µes)"]},
      {name:"Direito Previdenci√°rio", topics:["Segurados","Benef√≠cios","Car√™ncia/qualidade","C√°lculos (no√ß√µes)","Processo administrativo previdenci√°rio"]},
      {name:"Direito Constitucional", topics:["Seguridade social","Direitos fundamentais","Administra√ß√£o p√∫blica"]},
      {name:"Direito Administrativo", topics:["Princ√≠pios","Atos e poderes","Servidores","Responsabilidade do Estado"]},
      {name:"RLM", topics:["L√≥gica","Matem√°tica b√°sica","Porcentagem","Gr√°ficos"]},
      {name:"Inform√°tica", topics:["Office","Internet","Seguran√ßa da informa√ß√£o"]},
    ]
  },
  inss_tecnico: {
    name:"T√©cnico do INSS",
    subjects:[
      {name:"Portugu√™s", topics:["Interpreta√ß√£o","Pontua√ß√£o","Concord√¢ncia","Crase/reg√™ncia"]},
      {name:"Direito Previdenci√°rio", topics:["No√ß√µes de segurados","Benef√≠cios principais","Regras b√°sicas","Atendimento e processos (no√ß√µes)"]},
      {name:"√âtica/Atendimento", topics:["√âtica no servi√ßo p√∫blico","Comunica√ß√£o","Atendimento humanizado","LGPD (no√ß√µes)"]},
      {name:"RLM", topics:["Matem√°tica b√°sica","Porcentagem","Problemas","L√≥gica b√°sica"]},
      {name:"Inform√°tica", topics:["Office","Internet","Seguran√ßa"]},
    ]
  },
  pc_agente: {
    name:"Agente da Pol√≠cia Civil",
    subjects:[
      {name:"Direito Constitucional", topics:["Direitos fundamentais","Seguran√ßa p√∫blica (CF)","Administra√ß√£o p√∫blica e princ√≠pios","Controle de constitucionalidade"]},
      {name:"Direito Administrativo", topics:["Poder de pol√≠cia","Atos e poderes","Processo administrativo (no√ß√µes)","Improbidade (no√ß√µes)","Licita√ß√µes (no√ß√µes)"]},
      {name:"Direito Penal", topics:["Parte geral","Crimes contra a pessoa","Patrim√¥nio","Administra√ß√£o p√∫blica","Lei de Drogas (no√ß√µes)","Crimes hediondos (no√ß√µes)"]},
      {name:"Processo Penal", topics:["Inqu√©rito policial","A√ß√£o penal","Provas","Pris√µes e medidas cautelares","Procedimentos","Recursos (no√ß√µes)"]},
      {name:"Legisla√ß√£o Especial", topics:["Maria da Penha (no√ß√µes)","ECA (no√ß√µes)","Estatuto do Desarmamento (no√ß√µes)","Abuso de autoridade (no√ß√µes)"]},
      {name:"Portugu√™s", topics:["Interpreta√ß√£o","Gram√°tica aplicada","Pontua√ß√£o","Concord√¢ncia/reg√™ncia"]},
      {name:"RLM", topics:["L√≥gica","Problemas","Porcentagem","Sequ√™ncias"]},
      {name:"Inform√°tica", topics:["No√ß√µes gerais","Seguran√ßa","Internet"]},
    ]
  }
};

function subjectsForExam(examId){
  return (EXAMS[examId]?.subjects || []).map(s=>s.name);
}
function topicsFor(examId, subject){
  const s = (EXAMS[examId]?.subjects || []).find(x=>x.name===subject);
  return s ? s.topics : [];
}

// ---------- Plan Generator (pedagogical: BASE/APROF/CONS) ----------
function phaseForWeek(startDate){
  const start = new Date(startDate+"T00:00:00");
  const now = new Date(todayISO()+"T00:00:00");
  const diffDays = Math.floor((now - start)/(1000*60*60*24));
  const week = Math.max(0, Math.floor(diffDays/7));
  const mod = week % 3;
  return mod===0 ? "BASE" : (mod===1 ? "APROFUNDAMENTO" : "CONSOLIDA√á√ÉO");
}
function build7DayPlan(u){
  const start = new Date(u.startDate+"T00:00:00");
  const now = new Date(todayISO()+"T00:00:00");
  const diffDays = Math.max(0, Math.floor((now - start)/(1000*60*60*24)));
  const dayIndex = diffDays; // desde o in√≠cio
  const phase = phaseForWeek(u.startDate);

  const subs = EXAMS[u.examId]?.subjects || [];
  if(!subs.length) return { phase, days: [] };

  // Determina um offset por fase (para "avan√ßar" nos t√≥picos)
  const phaseOffset = phase==="BASE" ? 0 : (phase==="APROFUNDAMENTO" ? 1 : 2);

  const days = [];
  for(let i=0;i<7;i++){
    const d = addDaysISO(todayISO(), i);
    const globalIndex = dayIndex + i;

    const subj = subs[globalIndex % subs.length];
    const tlist = subj.topics || ["(defina t√≥picos)"];
    // pega t√≥pico alternando: base = primeiros; aprof = meio; cons = revis√£o
    let topic;
    if(phase==="CONSOLIDA√á√ÉO"){
      topic = `Revis√£o + Quest√µes: ${tlist[globalIndex % tlist.length]}`;
    }else{
      const tIdx = (globalIndex + phaseOffset) % tlist.length;
      topic = tlist[tIdx];
    }

    days.push({ date:d, subject: subj.name, topic });
  }
  return { phase, days };
}

// ---------- Revis√£o 7/15/30 ----------
function reviewIntervals(){ return [7,15,30]; }
function ensureErrorReviewFields(err){
  if(!err) return err;
  if(!err.createdDate) err.createdDate = err.date || todayISO();
  if(!err.reviewDone || typeof err.reviewDone !== "object"){
    err.reviewDone = { "7": false, "15": false, "30": false };
  }else{
    for(const d of reviewIntervals()){
      const k = String(d);
      if(typeof err.reviewDone[k] !== "boolean") err.reviewDone[k] = false;
    }
  }
  return err;
}
function nextReviewStage(err){
  ensureErrorReviewFields(err);
  const base = err.createdDate || err.date || todayISO();
  for(const d of reviewIntervals()){
    const k = String(d);
    if(!err.reviewDone[k]) return { key:k, intervalDays:d, dueDate:addDaysISO(base, d) };
  }
  return null;
}
function isReviewFullyDone(err){
  ensureErrorReviewFields(err);
  return reviewIntervals().every(d => !!err.reviewDone[String(d)]);
}
function errorReviewStatus(err, today){
  ensureErrorReviewFields(err);
  if(isReviewFullyDone(err)) return "DONE";
  const next = nextReviewStage(err);
  if(!next) return "DONE";
  if(today >= next.dueDate) return "DUE";
  if(next.dueDate <= addDaysISO(today, 7)) return "UPCOMING";
  return "SCHEDULED";
}
function countReviewPendings(u){
  const today = todayISO();
  let due=0, upcoming7=0, done=0;
  for(const e0 of (u.errors||[])){
    const e = ensureErrorReviewFields(e0);
    const st = errorReviewStatus(e, today);
    if(st==="DUE") due++;
    else if(st==="UPCOMING") upcoming7++;
    else if(st==="DONE") done++;
  }
  return { due, upcoming7, done, total:(u.errors||[]).length };
}

// ---------- Metrics ----------
function minutesLast7d(u){
  const today = todayISO();
  const start = addDaysISO(today, -6);
  return (u.logs||[]).filter(x=>x.date>=start && x.date<=today).reduce((s,x)=>s+(Number(x.minutes)||0),0);
}
function streak(u){
  const set = new Set((u.logs||[]).filter(x=>Number(x.minutes)>0).map(x=>x.date));
  let s=0;
  for(let i=0;i<3650;i++){
    const d = addDaysISO(todayISO(), -i);
    if(set.has(d)) s++;
    else break;
  }
  return s;
}
function bySubjectMinutes(u, days=30){
  const end = todayISO();
  const start = addDaysISO(end, -(days-1));
  const m = {};
  Object.values(u.tasks||{}).forEach(t=>{
    if(t.date>=start && t.date<=end && (t.status||"")=="DONE"){
      const sub = t.subject || "‚Äî";
      m[sub] = (m[sub]||0) + (Number(t.minutes||t.completed_minutes||t.planned_minutes)||0);
    }
  });
  return m;
}

function normTopic(s){ return String(s||"").toLowerCase().trim().replace(/\s+/g," "); }

function topicMatches(errTopic, curriculumTopic){
  const a = normTopic(errTopic);
  const b = normTopic(curriculumTopic);
  if(!a || !b) return false;
  if(a===b) return true;
  // aceita varia√ß√µes comuns: erro pode conter prefixos/sufixos
  return a.includes(b) || b.includes(a);
}

// MODO B: conta como "coberto" apenas quando o t√≥pico tiver pelo menos 1 erro com revis√£o 7/15/30 conclu√≠da
function coverageBySubject(u){
  const exam = EXAMS[u.examId];
  const res = {};
  if(!exam || !exam.subjects) return res;

  const errors = (u.errors||[]).map(ensureErrorReviewFields);

  for(const subj of exam.subjects){
    const topics = subj.topics || [];
    const doneSet = new Set();

    for(const tp of topics){
      const ok = errors.some(e=>{
        if((e.subject||"") !== subj.name) return false;
        if(!isReviewFullyDone(e)) return false;
        return topicMatches(e.topic, tp);
      });
      if(ok) doneSet.add(normTopic(tp));
    }

    const total = topics.length || 0;
    const done = doneSet.size;
    const pct = total ? Math.round((done/total)*100) : 0;
    const status = pct<=30 ? "weak" : (pct<=70 ? "mid" : "strong");

    res[subj.name] = { total, done, pct, status };
  }
  return res;
}

function statusLabel(s){
  if(s==="strong") return { emoji:"üü¢", text:"Forte" };
  if(s==="mid") return { emoji:"üü°", text:"Em consolida√ß√£o" };
  return { emoji:"üî¥", text:"Base fraca" };
}


// ---------- Tabs ----------
const TABS = [
  { id:"dashboard", label:"Dashboard", icon:"üìä" },
  { id:"hoje", label:"Hoje", icon:"‚úÖ" },
  { id:"cronograma", label:"Cronograma", icon:"üóìÔ∏è" },
  { id:"caderno", label:"Caderno", icon:"üìì" },
  { id:"backup", label:"Backup", icon:"üíæ" },
  { id:"cronometro", label:"Cron√¥metro", icon:"‚è±Ô∏è" },
  { id:"usuarios", label:"Usu√°rios", icon:"üë•" },
];

// ---------- App runtime ----------
let STATE = loadState() || defaultState();
function activeUser(){
  const id = STATE.activeUserId;
  if(!id || !STATE.users[id]) return null;
  return STATE.users[id];
}
function setActiveUser(id){
  STATE.activeUserId = id;
  saveState(STATE);
  refreshHeader();
  showTab("dashboard");
}

// ---------- Header + Tabs ----------
function renderTabs(){
  const el = $("#tabs");
  el.innerHTML = "";
  TABS.forEach(t=>{
    const b = document.createElement("button");
    b.className = "tab-btn";
    b.setAttribute("data-tab", t.id);
    b.innerHTML = `<span class="mr-2">${t.icon}</span>${escapeHtml(t.label)}`;
    b.onclick = ()=>showTab(t.id);
    el.appendChild(b);
  });
}
function setActiveTabUI(tabId){
  $$("#tabs .tab-btn").forEach(b=>{
    b.classList.toggle("active", b.getAttribute("data-tab")===tabId);
  });
}
function scrollTabs(dx){
  const sc = $("#tabs-scroll");
  sc.scrollBy({ left: dx, behavior:"smooth" });
}
window.scrollTabs = scrollTabs;

function refreshHeader(){
  const u = activeUser();
  $("#app-title").textContent = "StudyOS ‚Äî Alta Performance (MultiUser)";
  if(!u){
    $("#welcome-msg").textContent = "Crie seu perfil para come√ßar.";
    $("#header-stats").innerHTML = "";
    $("#mini-timer").classList.add("hidden");
    return;
  }
  $("#welcome-msg").textContent = `Ol√°, ${u.name} ‚Ä¢ ${EXAMS[u.examId]?.name || u.examId} ‚Ä¢ In√≠cio: ${u.startDate}`;
  const rev = countReviewPendings(u);
  const st = streak(u);
  const cov = coverageBySubject(u);
  const mins7 = minutesLast7d(u);
  $("#header-stats").innerHTML = `
    <span class="pill">Streak: <b>${st}d</b></span>
    <span class="pill">7d: <b>${mins7}m</b></span>
    <span class="pill">Revis√µes hoje: <b>${rev.due}</b></span>
    <button class="px-3 py-1.5 rounded-xl bg-white hover:bg-sky-50 border border-sky-200 text-slate-700 text-xs lift" onclick="showTab('caderno')">Ir p/ Revis√£o</button>
  `;
  $("#mini-timer").classList.remove("hidden");
}

// ---------- Views ----------
function showTab(tabId){
  const u = activeUser();
  setActiveTabUI(tabId);
  const root = $("#tab-root");

  // First-run gate
  if(!u && tabId !== "usuarios"){
    tabId = "usuarios";
    setActiveTabUI(tabId);
  }

  if(tabId==="usuarios") return renderUsers(root);
  if(!u) return renderUsers(root);

  if(tabId==="dashboard") return renderDashboard(root, u);
  if(tabId==="hoje") return renderHoje(root, u);
  if(tabId==="cronograma") return renderCronograma(root, u);
  if(tabId==="caderno") return renderCaderno(root, u);
  if(tabId==="backup") return renderBackup(root, u);
  if(tabId==="cronometro") return renderCronometro(root, u);

  root.innerHTML = `<div class="app-card bg-white p-6">Em constru√ß√£o</div>`;
}
window.showTab = showTab;

// ---------- Users tab ----------
function renderUsers(root){
  const users = Object.values(STATE.users);
  const activeId = STATE.activeUserId;

  root.innerHTML = `
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
      <div class="app-card bg-white p-6">
        <h2 class="text-xl font-semibold">Usu√°rios</h2>
        <p class="text-slate-600 text-sm mt-1">Cada amigo tem seus dados separados no seu pr√≥prio navegador (offline).</p>
        <div class="mt-4 space-y-2">
          ${users.length ? users.map(u=>`
            <div class="flex items-center justify-between gap-3 p-3 rounded-2xl border border-sky-100 bg-sky-50/40">
              <div>
                <div class="font-semibold text-slate-900">${escapeHtml(u.name)}</div>
                <div class="text-xs text-slate-600">${escapeHtml(EXAMS[u.examId]?.name||u.examId)} ‚Ä¢ in√≠cio ${u.startDate}</div>
              </div>
              <div class="flex gap-2">
                <button class="px-3 py-2 rounded-xl bg-white border border-sky-200 text-slate-700 text-sm lift" onclick="editUser('${u.id}')">Editar</button>
                <button class="px-3 py-2 rounded-xl ${u.id===activeId ? "bg-sky-600 text-white" : "bg-slate-900 text-white"} text-sm lift" onclick="setActiveUser('${u.id}')">${u.id===activeId ? "Ativo" : "Entrar"}</button>
              </div>
            </div>
          `).join("") : `<div class="text-sm text-slate-600">Nenhum usu√°rio ainda. Crie abaixo.</div>`}
        </div>
      </div>

      <div class="app-card bg-white p-6">
        <h2 class="text-xl font-semibold">Criar novo usu√°rio</h2>
        <div class="mt-4 grid grid-cols-1 md:grid-cols-2 gap-3">
          <div>
            <label class="text-xs text-slate-600">Nome</label>
            <input id="newName" class="w-full mt-1 px-3 py-2 rounded-xl border border-sky-200 focus:outline-none focus:ring-2 focus:ring-sky-200" placeholder="Ex.: Carolina" />
          </div>
          <div>
            <label class="text-xs text-slate-600">Cargo/Concurso</label>
            <select id="newExam" class="w-full mt-1 px-3 py-2 rounded-xl border border-sky-200 focus:outline-none focus:ring-2 focus:ring-sky-200">
              ${Object.entries(EXAMS).map(([k,v])=>`<option value="${k}">${escapeHtml(v.name)}</option>`).join("")}
            </select>
          </div>
          <div>
            <label class="text-xs text-slate-600">Data de in√≠cio</label>
            <input id="newStart" type="date" value="${todayISO()}" class="w-full mt-1 px-3 py-2 rounded-xl border border-sky-200 focus:outline-none focus:ring-2 focus:ring-sky-200" />
          </div>
          <div>
            <label class="text-xs text-slate-600">Meta semanal (min)</label>
            <input id="newGoal" type="number" value="1800" min="0" step="30" class="w-full mt-1 px-3 py-2 rounded-xl border border-sky-200 focus:outline-none focus:ring-2 focus:ring-sky-200" />
          </div>
        </div>
        <div class="mt-4 flex gap-2 justify-end">
          <button class="px-4 py-2 rounded-xl bg-slate-900 text-white text-sm lift" onclick="createUser()">Criar</button>
        </div>
      </div>
    </div>
  `;
}
window.createUser = function(){
  const name = ($("#newName").value||"").trim();
  const examId = $("#newExam").value;
  const startDate = $("#newStart").value || todayISO();
  const goal = Number($("#newGoal").value||1800);

  if(!name){ toast("Digite um nome."); return; }
  const u = makeUser(name);
  u.examId = examId;
  u.startDate = startDate;
  u.weeklyGoalMin = goal;

  STATE.users[u.id] = u;
  STATE.activeUserId = u.id;
  saveState(STATE);
  toast("Usu√°rio criado ‚úì");
  refreshHeader();
  showTab("dashboard");
};
window.editUser = function(id){
  const u = STATE.users[id];
  if(!u) return;
  openModal("Editar usu√°rio", `
    <div class="grid grid-cols-1 gap-3">
      <div>
        <label class="text-xs text-slate-600">Nome</label>
        <input id="edName" class="w-full mt-1 px-3 py-2 rounded-xl border border-sky-200" value="${escapeHtml(u.name)}"/>
      </div>
      <div>
        <label class="text-xs text-slate-600">Cargo</label>
        <select id="edExam" class="w-full mt-1 px-3 py-2 rounded-xl border border-sky-200">
          ${Object.entries(EXAMS).map(([k,v])=>`<option value="${k}" ${k===u.examId?"selected":""}>${escapeHtml(v.name)}</option>`).join("")}
        </select>
      </div>
      <div class="grid grid-cols-2 gap-3">
        <div>
          <label class="text-xs text-slate-600">In√≠cio</label>
          <input id="edStart" type="date" class="w-full mt-1 px-3 py-2 rounded-xl border border-sky-200" value="${u.startDate}"/>
        </div>
        <div>
          <label class="text-xs text-slate-600">Meta semanal (min)</label>
          <input id="edGoal" type="number" class="w-full mt-1 px-3 py-2 rounded-xl border border-sky-200" value="${u.weeklyGoalMin}" />
        </div>
      </div>
      <div class="border-t border-sky-100 pt-3">
        <button class="px-3 py-2 rounded-xl bg-rose-600 text-white text-sm lift" onclick="deleteUser('${u.id}')">Excluir usu√°rio</button>
      </div>
    </div>
  `, [
    { label:"Cancelar", className:"px-3 py-2 rounded-xl bg-white border border-sky-200 text-slate-700 text-sm lift", onClick: closeModal },
    { label:"Salvar", className:"px-3 py-2 rounded-xl bg-slate-900 text-white text-sm lift", onClick: ()=>{
      u.name = ($("#edName").value||"").trim() || u.name;
      u.examId = $("#edExam").value;
      u.startDate = $("#edStart").value || u.startDate;
      u.weeklyGoalMin = Number($("#edGoal").value||u.weeklyGoalMin);
      saveState(STATE);
      closeModal();
      toast("Salvo ‚úì");
      refreshHeader();
      showTab("usuarios");
    }}
  ]);
};
window.deleteUser = function(id){
  openModal("Confirmar exclus√£o", `<p class="text-sm text-slate-700">Excluir este usu√°rio remove os dados apenas deste navegador.</p>`, [
    { label:"Cancelar", className:"px-3 py-2 rounded-xl bg-white border border-sky-200 text-slate-700 text-sm lift", onClick: closeModal },
    { label:"Excluir", className:"px-3 py-2 rounded-xl bg-rose-600 text-white text-sm lift", onClick: ()=>{
      delete STATE.users[id];
      if(STATE.activeUserId===id) STATE.activeUserId = Object.keys(STATE.users)[0] || null;
      saveState(STATE);
      closeModal();
      toast("Exclu√≠do ‚úì");
      refreshHeader();
      showTab("usuarios");
    }}
  ]);
};

// ---------- Dashboard ----------
let CHART = null;
function renderDashboard(root, u){
  const plan = build7DayPlan(u);
  const rev = countReviewPendings(u);
  const mins7 = minutesLast7d(u);
  const st = streak(u);
  const cov = coverageBySubject(u);

  root.innerHTML = `
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
      <div class="app-card bg-white p-6 lg:col-span-2">
        <div class="flex items-start justify-between gap-3">
          <div>
            <h2 class="text-xl font-semibold">Dashboard</h2>
            <p class="text-slate-600 text-sm mt-1">Fase atual: <span class="badge">${plan.phase}</span></p>
          </div>
          <div class="flex gap-2 flex-wrap justify-end">
            <span class="pill">Streak <b>${st}d</b></span>
            <span class="pill">7d <b>${mins7}m</b></span>
            <span class="pill">Revis√µes hoje <b>${rev.due}</b></span>
            <button class="px-3 py-2 rounded-xl bg-sky-600 text-white text-sm lift" onclick="showTab('caderno')">Ir para Revis√£o</button>
          </div>
        </div>

        <div class="mt-4 grid grid-cols-2 md:grid-cols-4 gap-3">
          <div class="p-3 rounded-2xl border border-sky-100 bg-sky-50/40">
            <div class="text-2xl font-bold text-slate-900">${rev.due}</div>
            <div class="text-xs text-slate-600">Revis√µes vencidas</div>
          </div>
          <div class="p-3 rounded-2xl border border-sky-100 bg-sky-50/40">
            <div class="text-2xl font-bold text-slate-900">${rev.upcoming7}</div>
            <div class="text-xs text-slate-600">Pr√≥x. 7 dias</div>
          </div>
          <div class="p-3 rounded-2xl border border-sky-100 bg-sky-50/40">
            <div class="text-2xl font-bold text-slate-900">${u.weeklyGoalMin}</div>
            <div class="text-xs text-slate-600">Meta semanal (min)</div>
          </div>
          <div class="p-3 rounded-2xl border border-sky-100 bg-sky-50/40">
            <div class="text-2xl font-bold text-slate-900">${mins7}</div>
            <div class="text-xs text-slate-600">Feito (√∫ltimos 7d)</div>
          </div>
        </div>

        <div class="mt-5">
          <div class="flex items-center justify-between mb-2">
            <h3 class="font-semibold">Mapa por disciplina (30 dias)</h3>
            <span class="pill">auto</span>
          </div>
          <div class="p-3 rounded-2xl border border-sky-100 bg-white">
            <canvas id="chart" height="120"></canvas>
          </div>
        </div>
      </div>
        <div class="mt-5">
          <div class="flex items-center justify-between mb-2">
            <h3 class="font-semibold">Cobertura Real (Mem√≥ria Consolidada)</h3>
            <span class="pill">7/15/30</span>
          </div>
          <div class="space-y-2">
            ${Object.keys(cov).map(s=>{
              const c = cov[s];
              const sl = statusLabel(c.status);
              return `
                <div class="p-3 rounded-2xl border border-sky-100 bg-sky-50/40">
                  <div class="flex items-center justify-between gap-3">
                    <div class="font-semibold text-slate-900">${escapeHtml(s)}</div>
                    <div class="text-xs text-slate-600">${sl.emoji} ${sl.text} ‚Ä¢ <b>${c.done}/${c.total}</b> ‚Ä¢ <b>${c.pct}%</b></div>
                  </div>
                  <div class="mt-2 h-2.5 w-full bg-white rounded-full border border-sky-100 overflow-hidden">
                    <div class="h-full bg-sky-500" style="width:${c.pct}%;"></div>
                  </div>
                </div>
              `;
            }).join("")}
          </div>
        </div>


      
      <div class="app-card bg-white p-6">
        <div class="flex items-start justify-between gap-3">
          <div>
            <h3 class="text-lg font-semibold">Coach Inteligente</h3>
            <p class="text-slate-600 text-sm mt-1">Sugest√£o do dia (aprende com voc√™)</p>
          </div>
          <div class="flex gap-2 flex-wrap justify-end">
            <span id="dashCoachRiskBadge" class="pill">Risco <b>‚Äî</b></span>
            <span id="dashCoachPhaseBadge" class="pill">Fase <b>${plan.phase}</b></span>
          </div>
        </div>

        <div class="mt-4 p-4 rounded-2xl border border-sky-100 bg-sky-50/40">
          <div id="dashCoachTitle" class="text-sm font-semibold text-slate-900">‚Äî</div>
          <div id="dashCoachWhy" class="text-xs text-slate-600 mt-1">‚Äî</div>

          <div class="mt-3 grid grid-cols-2 gap-2">
            <div class="p-3 rounded-2xl bg-white border border-sky-100">
              <div class="text-xs text-slate-600">Foco</div>
              <div id="dashCoachFocus" class="text-sm font-semibold text-slate-900 mt-0.5">‚Äî</div>
            </div>
            <div class="p-3 rounded-2xl bg-white border border-sky-100">
              <div class="text-xs text-slate-600">Pr√≥ximo passo</div>
              <div id="dashCoachNext" class="text-sm font-semibold text-slate-900 mt-0.5">‚Äî</div>
            </div>
          </div>

          <div class="mt-3 flex gap-2 flex-wrap">
            <button id="dashCoachPrimary" class="px-4 py-2 rounded-xl bg-slate-900 text-white text-sm lift">Fazer agora</button>
            <button id="dashCoachSwap" class="px-4 py-2 rounded-xl bg-white border border-sky-200 text-slate-700 text-sm lift">Trocar</button>
            <button id="dashCoachDismiss" class="px-4 py-2 rounded-xl bg-white border border-sky-200 text-slate-700 text-sm lift">N√£o hoje</button>
          </div>

          <div class="mt-4 p-4 rounded-2xl bg-white border border-sky-100">
            <div class="flex items-start justify-between gap-3">
              <div>
                <div class="text-sm font-semibold text-slate-900">Miss√£o do Dia</div>
                <div id="dashMissionMeta" class="text-xs text-slate-600 mt-0.5">‚Äî</div>
              </div>
              <button id="dashMissionApply" class="px-3 py-2 rounded-xl bg-sky-600 text-white text-sm lift">Aplicar miss√£o</button>
            </div>
            <div id="dashMissionList" class="mt-3 space-y-2"></div>
          </div>

        </div>
      </div>

<div class="app-card bg-white p-6">
        <h3 class="text-lg font-semibold">Pr√≥ximos 7 dias</h3>
        <p class="text-xs text-slate-600 mt-1">Plano pedag√≥gico conectado (BASE ‚Üí APROF ‚Üí CONS)</p>
        <div class="mt-4 space-y-2">
          ${plan.days.map(d=>`
            <div class="p-3 rounded-2xl border border-sky-100 bg-sky-50/40">
              <div class="text-xs text-slate-600">${d.date}</div>
              <div class="font-semibold">${escapeHtml(d.subject)}</div>
              <div class="text-sm text-slate-700">${escapeHtml(d.topic)}</div>
            </div>
          `).join("")}
        </div>
      </div>
    </div>
  `;

  coachRenderDashboard(u, plan, rev, cov, mins7, st);
  // chart
  const ctx = $("#chart");
  const data = bySubjectMinutes(u, 30);
  const labels = Object.keys(data);
  const values = Object.values(data);
  if(CHART) CHART.destroy();
  if(ctx){
    CHART = new Chart(ctx, {
      type: 'bar',
      data: { labels, datasets: [{ label:'Minutos', data: values }] },
      options: {
        responsive:true,
        plugins:{ legend:{ display:false } },
        scales:{ x:{ ticks:{ color:"#334155" } }, y:{ ticks:{ color:"#334155" } } }
      }
    });
  }
}

// ---------- Hoje ----------
function renderHoje(root, u){
  const plan = build7DayPlan(u);
  const todayPlan = plan.days[0] || { subject: subjectsForExam(u.examId)[0]||"", topic:"" };

  root.innerHTML = `
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
      <div class="app-card bg-white p-6 lg:col-span-2">
        <div class="flex items-start justify-between gap-3">
          <div>
            <h2 class="text-xl font-semibold">Hoje</h2>
            <p class="text-slate-600 text-sm mt-1"><b>${todayISO()}</b> ‚Ä¢ Plano: <b>${escapeHtml(todayPlan.subject)}</b> ‚Äî ${escapeHtml(todayPlan.topic)}</p>
          </div>
          <span class="pill">Fase: <b>${plan.phase}</b></span>
        </div>

        <div class="mt-4 grid grid-cols-1 md:grid-cols-2 gap-3">
          <div class="p-4 rounded-2xl border border-sky-100 bg-sky-50/40">
            <div class="text-sm font-semibold mb-2">LOG (minutos)</div>
            <div class="flex gap-2">
              <input id="logMin" type="number" min="0" step="5" class="w-full px-3 py-2 rounded-xl border border-sky-200" placeholder="Ex.: 90" />
              <button class="px-4 py-2 rounded-xl bg-slate-900 text-white text-sm lift" onclick="saveLog()">Salvar</button>
            </div>
          </div>

          <div class="p-4 rounded-2xl border border-sky-100 bg-sky-50/40">
            <div class="text-sm font-semibold mb-2">Tarefa conclu√≠da (vira mapa)</div>
            <div class="grid grid-cols-1 gap-2">
              <select id="tSub" class="w-full px-3 py-2 rounded-xl border border-sky-200">
                ${subjectsForExam(u.examId).map(s=>`<option ${s===todayPlan.subject?"selected":""}>${escapeHtml(s)}</option>`).join("")}
              </select>
              <input id="tTop" class="w-full px-3 py-2 rounded-xl border border-sky-200" value="${escapeHtml(todayPlan.topic)}" />
              <div class="flex gap-2">
                <input id="tMin" type="number" min="0" step="5" class="w-full px-3 py-2 rounded-xl border border-sky-200" placeholder="Minutos" />
                <button class="px-4 py-2 rounded-xl bg-sky-600 text-white text-sm lift" onclick="saveTask()">Concluir</button>
              </div>
            </div>
          </div>
        </div>

        <div class="mt-4 p-4 rounded-2xl border border-sky-100 bg-white">
          <div class="flex items-center justify-between">
            <div>
              <div class="font-semibold">Atalho</div>
              <div class="text-sm text-slate-600">O Caderno (anota√ß√µes/erros + revis√£o) fica na aba <b>Caderno</b>.</div>
            </div>
            <button class="px-4 py-2 rounded-xl bg-white border border-sky-200 text-slate-700 text-sm lift" onclick="showTab('caderno')">Abrir Caderno</button>
          </div>
        </div>
      </div>

      <div class="app-card bg-white p-6">
        <h3 class="text-lg font-semibold">Resumo</h3>
        <div class="mt-3 space-y-2 text-sm">
          <div class="flex justify-between"><span class="text-slate-600">√öltimos 7 dias</span><b>${minutesLast7d(u)} min</b></div>
          <div class="flex justify-between"><span class="text-slate-600">Meta semanal</span><b>${u.weeklyGoalMin} min</b></div>
          <div class="flex justify-between"><span class="text-slate-600">Streak</span><b>${streak(u)} dias</b></div>
        </div>
        <div class="mt-4">
          <h4 class="font-semibold">√öltimos logs</h4>
          <div class="mt-2 space-y-2">
            ${(u.logs||[]).slice(0,6).map(l=>`
              <div class="p-3 rounded-2xl border border-sky-100 bg-sky-50/40 flex justify-between text-sm">
                <span class="text-slate-600">${l.date}</span>
                <b>${l.minutes}m</b>
              </div>
            `).join("") || `<div class="text-sm text-slate-600">Sem logs ainda.</div>`}
          </div>
        </div>
      </div>
    </div>
  `;

  window.saveLog = ()=>{
    const m = Number($("#logMin").value||0);
    if(!m){ toast("Informe minutos > 0"); return; }
    u.logs.unshift({ date: todayISO(), minutes:m, at: new Date().toISOString(), hour: new Date().getHours() });
    saveState(STATE);
    toast("LOG salvo ‚úì");
    refreshHeader();
    showTab("hoje");
  };
  window.saveTask = ()=>{
    const sub = $("#tSub").value;
    const top = ($("#tTop").value||"").trim();
    const m = Number($("#tMin").value||0);
    if(!sub || !m){ toast("Preencha disciplina e minutos"); return; }
    const id = uid("t");
    u.tasks[id] = { id, date: todayISO(), subject: sub, topic: top, minutes:m, status:"DONE" };
    saveState(STATE);
    toast("Tarefa conclu√≠da ‚úì");
    refreshHeader();
    showTab("hoje");
  };
}

// ---------- Cronograma ----------
function renderCronograma(root, u){
  const plan = build7DayPlan(u);
  const cov = coverageBySubject(u);
  root.innerHTML = `
    <div class="app-card bg-white p-6">
      <div class="flex items-start justify-between gap-3">
        <div>
          <h2 class="text-xl font-semibold">Cronograma</h2>
          <p class="text-slate-600 text-sm mt-1">Cobertura total em ciclos pedag√≥gicos: <b>BASE ‚Üí APROFUNDAMENTO ‚Üí CONSOLIDA√á√ÉO</b>.</p>
        </div>
        <span class="pill">Fase: <b>${plan.phase}</b></span>
      </div>

      <div class="mt-5 grid grid-cols-1 md:grid-cols-2 gap-3">
        ${plan.days.map((d,i)=>`
          <div class="p-4 rounded-2xl border border-sky-100 ${i===0?"bg-white":"bg-sky-50/40"}">
            <div class="flex items-center justify-between">
              <div class="text-xs text-slate-600">${d.date}</div>
              ${i===0?`<span class="badge today">hoje</span>`:""}
            </div>
            <div class="mt-1 font-semibold">${escapeHtml(d.subject)}</div>
            <div class="text-xs text-slate-600 mt-1">${(()=>{ const c=cov[d.subject]||{done:0,total:0,pct:0,status:"weak"}; const sl=statusLabel(c.status); return sl.emoji + " " + c.done + "/" + c.total + " consolidados ‚Ä¢ " + c.pct + "%"; })()}</div>
            <div class="text-sm text-slate-700 mt-1">${escapeHtml(d.topic)}</div>
          </div>
        `).join("")}
      </div>

      <div class="mt-6 p-4 rounded-2xl border border-sky-100 bg-sky-50/40">
        <div class="font-semibold">Como usar</div>
        <ul class="list-disc pl-5 text-sm text-slate-700 mt-2 space-y-1">
          <li>No <b>Hoje</b>, registre minutos e tarefas conclu√≠das para alimentar o Dashboard.</li>
          <li>No <b>Caderno</b>, registre anota√ß√µes e erros (erros entram no pipeline de revis√£o 7/15/30).</li>
          <li>Na <b>Consolida√ß√£o</b>, priorize quest√µes + revis√£o dos erros.</li>
        </ul>
      </div>
    </div>
  `;
}

// ---------- Caderno + Revis√£o ----------
function renderCaderno(root, u){
  u.prefs = u.prefs || { nbMode:"Anota√ß√µes", nbQuery:"", revFilter:"DUE" };
  const mode = u.prefs.nbMode || "Anota√ß√µes";
  const q = (u.prefs.nbQuery||"").toLowerCase();
  const today = todayISO();

  const notesFiltered = (u.notes||[]).filter(n=>{
    if(!q) return true;
    return (n.text||"").toLowerCase().includes(q) || (n.date||"").includes(q);
  });

  const errorsAll = (u.errors||[]).map(ensureErrorReviewFields);
  const errorsFiltered = errorsAll.filter(e=>{
    if(!q) return true;
    const blob = `${e.subject||""} ${e.topic||""} ${e.why||""} ${e.fix||""} ${e.date||""}`.toLowerCase();
    return blob.includes(q);
  });

  const counts = countReviewPendings(u);

  // review table filter
  const f = u.prefs.revFilter || "DUE";
  const revList = errorsAll.filter(e=>{
    const st = errorReviewStatus(e, today);
    if(f==="ALL") return true;
    if(f==="DUE") return st==="DUE";
    if(f==="UPCOMING") return st==="UPCOMING";
    if(f==="DONE") return st==="DONE";
    return true;
  });

  const subjects = subjectsForExam(u.examId);

  root.innerHTML = `
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
      <div class="app-card bg-white p-6 lg:col-span-2">
        <div class="flex items-start justify-between gap-3">
          <div>
            <h2 class="text-xl font-semibold">Caderno Inteligente</h2>
            <p class="text-slate-600 text-sm mt-1">Um lugar s√≥: Anota√ß√µes + Caderno de Erros + Revis√£o 7/15/30.</p>
          </div>
          <span class="pill">${escapeHtml(EXAMS[u.examId]?.name||u.examId)}</span>
        </div>

        <div class="mt-4 grid grid-cols-1 md:grid-cols-2 gap-3">
          <div>
            <label class="text-xs text-slate-600">Modo</label>
            <select id="nbMode" class="w-full mt-1 px-3 py-2 rounded-xl border border-sky-200">
              <option value="Anota√ß√µes" ${mode==="Anota√ß√µes"?"selected":""}>Caderno normal (Anota√ß√µes)</option>
              <option value="Erros" ${mode==="Erros"?"selected":""}>Caderno de Erros</option>
            </select>
          </div>
          <div>
            <label class="text-xs text-slate-600">Buscar</label>
            <input id="nbQuery" class="w-full mt-1 px-3 py-2 rounded-xl border border-sky-200" placeholder="palavra, data, disciplina..." value="${escapeHtml(u.prefs.nbQuery||"")}"/>
          </div>
        </div>

        <div class="mt-4 grid grid-cols-1 md:grid-cols-2 gap-3">
          <div>
            <label class="text-xs text-slate-600">Disciplina</label>
            <select id="nbSub" class="w-full mt-1 px-3 py-2 rounded-xl border border-sky-200">
              ${subjects.map(s=>`<option>${escapeHtml(s)}</option>`).join("")}
            </select>
          </div>
          <div>
            <label class="text-xs text-slate-600">T√≥pico</label>
            <input id="nbTop" class="w-full mt-1 px-3 py-2 rounded-xl border border-sky-200" placeholder="Ex.: Compet√™ncia / Benef√≠cios / Provas..." />
          </div>
        </div>

        <div id="nbForm" class="mt-4"></div>

        <div class="mt-6">
          ${mode==="Erros" ? `
            <h3 class="font-semibold">Erros (filtrados)</h3>
            <div class="mt-2 overflow-x-auto">
              <table class="w-full text-sm">
                <thead><tr class="text-slate-600">
                  <th class="text-left py-2 pr-2">Data</th><th class="text-left py-2 pr-2">Disciplina</th><th class="text-left py-2 pr-2">T√≥pico</th><th class="text-left py-2">A√ß√£o</th>
                </tr></thead>
                <tbody>
                  ${errorsFiltered.slice(0,80).map(e=>`
                    <tr class="border-t border-sky-100">
                      <td class="py-2 pr-2">${e.date}</td>
                      <td class="py-2 pr-2">${escapeHtml(e.subject)}</td>
                      <td class="py-2 pr-2">${escapeHtml(e.topic)}</td>
                      <td class="py-2"><button class="px-3 py-1.5 rounded-xl bg-white border border-sky-200 text-slate-700 text-xs lift" data-open="${e.id}">ver</button></td>
                    </tr>
                  `).join("") || `<tr><td colspan="4" class="py-3 text-slate-600">Nenhum erro.</td></tr>`}
                </tbody>
              </table>
            </div>
          ` : `
            <h3 class="font-semibold">Anota√ß√µes (filtradas)</h3>
            <div class="mt-2 space-y-2">
              ${notesFiltered.slice(0,20).map(n=>`
                <div class="p-3 rounded-2xl border border-sky-100 bg-sky-50/40">
                  <div class="text-xs text-slate-600">${n.date}</div>
                  <div class="text-sm text-slate-800 whitespace-pre-wrap">${escapeHtml(n.text)}</div>
                </div>
              `).join("") || `<div class="text-sm text-slate-600">Nenhuma anota√ß√£o.</div>`}
            </div>
          `}
        </div>
      </div>

      <div class="app-card bg-white p-6">
        <h2 class="text-lg font-semibold">Revis√£o (7 ‚Ä¢ 15 ‚Ä¢ 30)</h2>
        <p class="text-slate-600 text-sm mt-1">Pipeline autom√°tico a partir do Caderno de Erros.</p>

        <div class="mt-3 flex gap-2 flex-wrap">
          <span class="pill">Pendentes hoje: <b>${counts.due}</b></span>
          <span class="pill">Pr√≥x. 7d: <b>${counts.upcoming7}</b></span>
          <span class="pill">Conclu√≠dos: <b>${counts.done}</b></span>
        </div>

        <div class="mt-4 flex gap-2 flex-wrap">
          <button class="px-3 py-2 rounded-xl ${u.prefs.revFilter==="DUE"?"bg-sky-600 text-white":"bg-white border border-sky-200 text-slate-700"} text-xs lift" data-rf="DUE">Vencidos</button>
          <button class="px-3 py-2 rounded-xl ${u.prefs.revFilter==="UPCOMING"?"bg-sky-600 text-white":"bg-white border border-sky-200 text-slate-700"} text-xs lift" data-rf="UPCOMING">Pr√≥ximos 7d</button>
          <button class="px-3 py-2 rounded-xl ${u.prefs.revFilter==="DONE"?"bg-sky-600 text-white":"bg-white border border-sky-200 text-slate-700"} text-xs lift" data-rf="DONE">Conclu√≠dos</button>
          <button class="px-3 py-2 rounded-xl ${u.prefs.revFilter==="ALL"?"bg-sky-600 text-white":"bg-white border border-sky-200 text-slate-700"} text-xs lift" data-rf="ALL">Todos</button>
        </div>

        <div class="mt-4 overflow-x-auto">
          <table class="w-full text-sm">
            <thead><tr class="text-slate-600">
              <th class="text-left py-2 pr-2">Status</th>
              <th class="text-left py-2 pr-2">Disc.</th>
              <th class="text-left py-2 pr-2">T√≥pico</th>
              <th class="text-left py-2 pr-2">Pr√≥xima</th>
              <th class="text-left py-2">A√ß√£o</th>
            </tr></thead>
            <tbody>
              ${revList.slice(0,60).map(e=>{
                const st = errorReviewStatus(e, today);
                const next = nextReviewStage(e);
                const badge = st==="DUE" ? `<span class="badge danger">VENCIDO</span>` :
                              st==="UPCOMING" ? `<span class="badge">PR√ìXIMO</span>` :
                              st==="DONE" ? `<span class="badge today">OK</span>` : `<span class="badge">AGENDADO</span>`;
                const when = (next && st!=="DONE") ? `${next.dueDate} (D+${next.intervalDays})` : "‚Äî";
                const action = (st==="DUE") 
                  ? `<button class="px-3 py-1.5 rounded-xl bg-sky-600 text-white text-xs lift" data-dorev="${e.id}">marcar</button>`
                  : `<button class="px-3 py-1.5 rounded-xl bg-white border border-sky-200 text-slate-700 text-xs lift" data-rev="${e.id}">ver</button>`;
                return `<tr class="border-t border-sky-100">
                  <td class="py-2 pr-2">${badge}</td>
                  <td class="py-2 pr-2">${escapeHtml(e.subject)}</td>
                  <td class="py-2 pr-2">${escapeHtml(e.topic)}</td>
                  <td class="py-2 pr-2">${escapeHtml(when)}</td>
                  <td class="py-2">${action}</td>
                </tr>`;
              }).join("") || `<tr><td colspan="5" class="py-3 text-slate-600">Nenhum item neste filtro.</td></tr>`}
            </tbody>
          </table>
        </div>

        <div class="mt-4 p-3 rounded-2xl border border-sky-100 bg-sky-50/40 text-xs text-slate-700">
          Quando estiver <b>VENCIDO</b>, clique em <b>marcar</b> para avan√ßar (7 ‚Üí 15 ‚Üí 30).
        </div>
      </div>
    </div>
  `;

  // form render
  function renderForm(){
    const modeNow = $("#nbMode").value;
    const sub = $("#nbSub").value;
    const top = ($("#nbTop").value||"").trim();

    if(modeNow==="Erros"){
      $("#nbForm").innerHTML = `
        <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
          <div>
            <label class="text-xs text-slate-600">Por que errei?</label>
            <textarea id="errWhy" class="w-full mt-1 px-3 py-2 rounded-xl border border-sky-200 h-28" placeholder="Ex.: confundi compet√™ncia material/territorial..."></textarea>
          </div>
          <div>
            <label class="text-xs text-slate-600">Corre√ß√£o / Regra</label>
            <textarea id="errFix" class="w-full mt-1 px-3 py-2 rounded-xl border border-sky-200 h-28" placeholder="Ex.: art. X + s√∫mula Y..."></textarea>
          </div>
        </div>
        <div class="mt-3 flex justify-end">
          <button class="px-4 py-2 rounded-xl bg-slate-900 text-white text-sm lift" id="saveErr">Salvar erro ‚Üí Revis√£o</button>
        </div>
      `;
      $("#saveErr").onclick = ()=>{
        const why = ($("#errWhy").value||"").trim();
        const fix = ($("#errFix").value||"").trim();
        if(!sub || !top || !why || !fix){ toast("Preencha disciplina, t√≥pico, por que errei e corre√ß√£o."); return; }
        const e = ensureErrorReviewFields({ id: uid("e"), date: todayISO(), createdDate: todayISO(), subject: sub, topic: top, why, fix });
        u.errors.unshift(e);
        saveState(STATE);
        toast("Erro salvo ‚úì (entrou na revis√£o)");
        refreshHeader();
        showTab("caderno");
      };
    }else{
      $("#nbForm").innerHTML = `
        <div>
          <label class="text-xs text-slate-600">Anota√ß√£o</label>
          <textarea id="noteText" class="w-full mt-1 px-3 py-2 rounded-xl border border-sky-200 h-28" placeholder="Resumo, insights, links..."></textarea>
        </div>
        <div class="mt-3 flex justify-end">
          <button class="px-4 py-2 rounded-xl bg-slate-900 text-white text-sm lift" id="saveNote">Salvar anota√ß√£o</button>
        </div>
      `;
      $("#saveNote").onclick = ()=>{
        const txt = ($("#noteText").value||"").trim();
        if(!sub || !txt){ toast("Preencha disciplina e anota√ß√£o."); return; }
        const header = top ? `[${sub}] (${top}) ` : `[${sub}] `;
        u.notes.unshift({ id: uid("n"), date: todayISO(), text: header + txt });
        saveState(STATE);
        toast("Anota√ß√£o salva ‚úì");
        refreshHeader();
        showTab("caderno");
      };
    }
  }
  renderForm();

  // wire
  $("#nbMode").onchange = ()=>{
    u.prefs.nbMode = $("#nbMode").value;
    saveState(STATE);
    showTab("caderno");
  };
  $("#nbQuery").oninput = ()=>{
    u.prefs.nbQuery = $("#nbQuery").value || "";
    saveState(STATE);
    showTab("caderno");
  };
  $$("button[data-rf]").forEach(b=>{
    b.onclick = ()=>{
      u.prefs.revFilter = b.getAttribute("data-rf");
      saveState(STATE);
      showTab("caderno");
    };
  });
  $$("button[data-open]").forEach(b=>{
    b.onclick = ()=>{
      const id = b.getAttribute("data-open");
      const e = (u.errors||[]).find(x=>x.id===id);
      if(!e) return;
      openModal("Erro", `<div class="text-sm">
        <div class="text-slate-600">${e.date} ‚Ä¢ <b>${escapeHtml(e.subject)}</b></div>
        <div class="mt-2"><b>T√≥pico:</b> ${escapeHtml(e.topic)}</div>
        <div class="mt-2"><b>Por que errei:</b><div class="whitespace-pre-wrap mt-1">${escapeHtml(e.why)}</div></div>
        <div class="mt-2"><b>Corre√ß√£o:</b><div class="whitespace-pre-wrap mt-1">${escapeHtml(e.fix)}</div></div>
      </div>`, [{ label:"Fechar", className:"px-3 py-2 rounded-xl bg-white border border-sky-200 text-slate-700 text-sm lift", onClick: closeModal }]);
    };
  });
  $$("button[data-rev]").forEach(b=>{
    b.onclick = ()=>{
      const id = b.getAttribute("data-rev");
      const e = (u.errors||[]).find(x=>x.id===id);
      if(!e) return;
      ensureErrorReviewFields(e);
      const st = errorReviewStatus(e, todayISO());
      const next = nextReviewStage(e);
      openModal("Revis√£o ‚Äî Detalhe", `<div class="text-sm">
        <div class="text-slate-600">Status: <b>${st}</b> ‚Ä¢ Pr√≥xima: <b>${escapeHtml(next?next.dueDate:"‚Äî")}</b></div>
        <div class="mt-2"><b>${escapeHtml(e.subject)}</b> ‚Äî ${escapeHtml(e.topic)}</div>
        <div class="mt-3"><b>Erro:</b><div class="whitespace-pre-wrap mt-1">${escapeHtml(e.why)}</div></div>
        <div class="mt-3"><b>Corre√ß√£o:</b><div class="whitespace-pre-wrap mt-1">${escapeHtml(e.fix)}</div></div>
      </div>`, [{ label:"Fechar", className:"px-3 py-2 rounded-xl bg-white border border-sky-200 text-slate-700 text-sm lift", onClick: closeModal }]);
    };
  });
  $$("button[data-dorev]").forEach(b=>{
    b.onclick = ()=>{
      const id = b.getAttribute("data-dorev");
      const e = (u.errors||[]).find(x=>x.id===id);
      if(!e) return;
      ensureErrorReviewFields(e);
      const next = nextReviewStage(e);
      if(!next){ toast("J√° conclu√≠do."); return; }
      e.reviewDone[next.key] = true;
      saveState(STATE);
      toast("Revis√£o marcada ‚úì");
      refreshHeader();
      showTab("caderno");
    };
  });
}

// ---------- Backup (Export/Import) ----------
function renderBackup(root, u){
  root.innerHTML = `
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
      <div class="app-card bg-white p-6">
        <h2 class="text-xl font-semibold">Backup</h2>
        <p class="text-slate-600 text-sm mt-1">Exporta/Importa dados do usu√°rio ativo (JSON). Ideal para mover PC ‚Üî celular.</p>

        <div class="mt-4 flex gap-2 flex-wrap">
          <button class="px-4 py-2 rounded-xl bg-slate-900 text-white text-sm lift" onclick="exportUser()">Exportar usu√°rio</button>
          <button class="px-4 py-2 rounded-xl bg-white border border-sky-200 text-slate-700 text-sm lift" onclick="showImport()">Importar usu√°rio</button>
        </div>

        <div class="mt-4 p-4 rounded-2xl border border-sky-100 bg-sky-50/40 text-sm text-slate-700">
          <b>Dica:</b> Para 7 amigos, cada um pode exportar seu JSON e guardar no Google Drive/WhatsApp.
        </div>
      </div>

      <div class="app-card bg-white p-6">
        <h3 class="text-lg font-semibold">Export r√°pido (estado completo)</h3>
        <p class="text-slate-600 text-sm mt-1">Para voc√™, administradora: exporta tudo (todos usu√°rios) deste navegador.</p>
        <div class="mt-4 flex gap-2">
          <button class="px-4 py-2 rounded-xl bg-sky-600 text-white text-sm lift" onclick="exportAll()">Exportar TUDO</button>
        </div>
      </div>
    </div>
  `;
}
window.exportUser = ()=>{
  const u = activeUser();
  if(!u){ toast("Sem usu√°rio ativo"); return; }
  const blob = new Blob([JSON.stringify(u,null,2)], {type:"application/json"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = `StudyOS_${u.name.replace(/\s+/g,"_")}_${u.examId}.json`;
  a.click();
  URL.revokeObjectURL(a.href);
  toast("Exportado ‚úì");
};
window.exportAll = ()=>{
  const blob = new Blob([JSON.stringify(STATE,null,2)], {type:"application/json"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = `StudyOS_MULTIUSERS_backup.json`;
  a.click();
  URL.revokeObjectURL(a.href);
  toast("Exportado ‚úì");
};
window.showImport = ()=>{
  openModal("Importar usu√°rio", `
    <div class="text-sm text-slate-700">
      Cole aqui o JSON exportado (ou selecione o arquivo via arrastar/colar).
    </div>
    <textarea id="importText" class="w-full mt-3 px-3 py-2 rounded-xl border border-sky-200 h-48" placeholder="{ ... }"></textarea>
    <div class="text-xs text-slate-600 mt-2">Importar cria um novo usu√°rio (n√£o sobrescreve).</div>
  `, [
    { label:"Cancelar", className:"px-3 py-2 rounded-xl bg-white border border-sky-200 text-slate-700 text-sm lift", onClick: closeModal },
    { label:"Importar", className:"px-3 py-2 rounded-xl bg-slate-900 text-white text-sm lift", onClick: ()=>{
      try{
        const obj = JSON.parse($("#importText").value||"{}");
        if(!obj || !obj.name || !obj.examId){ toast("JSON inv√°lido"); return; }
        const u = makeUser(obj.name);
        // merge safe
        Object.assign(u, obj);
        u.id = uid("u");
        STATE.users[u.id] = u;
        STATE.activeUserId = u.id;
        saveState(STATE);
        closeModal();
        toast("Importado ‚úì");
        refreshHeader();
        showTab("dashboard");
      }catch(e){ toast("Falha ao importar"); console.warn(e); }
    }}
  ]);
};

// ---------- Cronometro (simples) ----------
let TIMER = { running:false, startTs:0, elapsed:0, tick:null, targetMins:null, autoStop:false };
function formatMMSS(ms){
  const s = Math.floor(ms/1000);
  const mm = String(Math.floor(s/60)).padStart(2,"0");
  const ss = String(s%60).padStart(2,"0");
  return `${mm}:${ss}`;
}
function updateMini(){
  const el = $("#mini-timer-display");
  if(!el) return;
  const ms = TIMER.elapsed + (TIMER.running ? (Date.now()-TIMER.startTs) : 0);
  // auto-stop ao bater meta (se preset)
  if(TIMER.autoStop && TIMER.targetMins){
    const mins = ms/60000;
    if(mins >= TIMER.targetMins){
      window.timerPause();
      TIMER.autoStop = false;
      toast(`Meta atingida (${TIMER.targetMins} min) ‚úì`);
    }
  }
  el.textContent = formatMMSS(ms);
}
function renderCronometro(root, u){
  root.innerHTML = `
    <div class="app-card bg-white p-6">
      <div class="flex items-start justify-between">
        <div>
          <h2 class="text-xl font-semibold">Cron√¥metro</h2>
          <p class="text-slate-600 text-sm mt-1">Use para blocos de foco. (Opcional: depois conectamos ao LOG automaticamente.)</p>
        </div>
        <span class="pill">offline</span>
      </div>

      <div class="mt-6 flex flex-col items-center gap-4">
        <div id="bigTimer" class="text-6xl font-mono font-bold text-sky-700">00:00</div>
        <div id="focusTarget" class="hidden text-xs text-slate-600 px-3 py-1 rounded-full bg-sky-50 border border-sky-100"> </div>
        <div class="flex gap-2">
          <button class="px-4 py-2 rounded-xl bg-slate-900 text-white text-sm lift" onclick="timerStart()">Start</button>
          <button class="px-4 py-2 rounded-xl bg-white border border-sky-200 text-slate-700 text-sm lift" onclick="timerPause()">Pause</button>
          <button class="px-4 py-2 rounded-xl bg-rose-600 text-white text-sm lift" onclick="timerReset()">Reset</button>
        </div>
        <div class="flex gap-2 flex-wrap justify-center">
          <button class="px-3 py-1.5 rounded-xl bg-white border border-sky-200 text-slate-700 text-xs lift" onclick="startFocusBlock(25)">25 min</button>
          <button class="px-3 py-1.5 rounded-xl bg-white border border-sky-200 text-slate-700 text-xs lift" onclick="startFocusBlock(45)">45 min</button>
          <button class="px-3 py-1.5 rounded-xl bg-white border border-sky-200 text-slate-700 text-xs lift" onclick="startFocusBlock(60)">60 min</button>
          <button class="px-3 py-1.5 rounded-xl bg-white border border-sky-200 text-slate-700 text-xs lift" onclick="startFocusBlock(90)">90 min</button>
        </div>

        <div class="p-4 rounded-2xl border border-sky-100 bg-sky-50/40 w-full max-w-xl">
          <div class="text-sm font-semibold">Salvar como LOG</div>
          <div class="text-xs text-slate-600 mt-1">Converte o tempo atual em minutos e salva no Hoje.</div>
          <div class="mt-3 flex gap-2">
            <button class="px-4 py-2 rounded-xl bg-sky-600 text-white text-sm lift" onclick="timerSaveLog()">Salvar LOG</button>
            <button class="px-4 py-2 rounded-xl bg-white border border-sky-200 text-slate-700 text-sm lift" onclick="showTab('hoje')">Ir para Hoje</button>
          </div>
        </div>
      </div>
    </div>
  `;
  updateBig();
}
function updateBig(){
  const el = $("#bigTimer");
  if(!el) return;
  const ms = TIMER.elapsed + (TIMER.running ? (Date.now()-TIMER.startTs) : 0);
  // auto-stop ao bater meta (se preset)
  if(TIMER.autoStop && TIMER.targetMins){
    const mins = ms/60000;
    if(mins >= TIMER.targetMins){
      window.timerPause();
      TIMER.autoStop = false;
      toast(`Meta atingida (${TIMER.targetMins} min) ‚úì`);
    }
  }
  el.textContent = formatMMSS(ms);
  updateMini();
  updateFocusTargetUI();
}
window.timerStart = ()=>{
  if(TIMER.running) return;
  TIMER.running = true;
  TIMER.startTs = Date.now();
  TIMER.tick = setInterval(updateBig, 250);
  $("#mini-timer").classList.remove("hidden");
};
window.timerPause = ()=>{
  if(!TIMER.running) return;
  TIMER.elapsed += (Date.now()-TIMER.startTs);
  TIMER.running = false;
  clearInterval(TIMER.tick);
  TIMER.tick = null;
  updateBig();
};
window.timerReset = ()=>{
  TIMER.running = false;
  TIMER.elapsed = 0;
  clearInterval(TIMER.tick);
  TIMER.tick = null;
  updateBig();
};

function updateFocusTargetUI(){
  const el = $("#focusTarget");
  if(!el) return;
  if(TIMER.targetMins){
    el.textContent = `Bloco alvo: ${TIMER.targetMins} min`;
    el.classList.remove("hidden");
  } else {
    el.textContent = "";
    el.classList.add("hidden");
  }
}

// Inicia um bloco de foco com preset (1 clique no Coach -> j√° abre e come√ßa)
window.startFocusBlock = (mins)=>{
  const u = activeUser();
  if(u){
    coachEnsure?.(u);
    u.coach.lastBlockMins = mins;
    saveState(STATE);
  }
  TIMER.targetMins = mins;
  TIMER.autoStop = true;
  showTab("cronometro");
  setTimeout(()=>{
    window.timerReset();
    updateFocusTargetUI();
    window.timerStart();
    toast(`Bloco iniciado: ${mins} min ‚úì`);
  }, 40);
};
window.timerSaveLog = ()=>{
  const u = activeUser();
  if(!u) return;
  const ms = TIMER.elapsed + (TIMER.running ? (Date.now()-TIMER.startTs) : 0);
  // auto-stop ao bater meta (se preset)
  if(TIMER.autoStop && TIMER.targetMins){
    const mins = ms/60000;
    if(mins >= TIMER.targetMins){
      window.timerPause();
      TIMER.autoStop = false;
      toast(`Meta atingida (${TIMER.targetMins} min) ‚úì`);
    }
  }
  const mins = Math.max(1, Math.round(ms/60000));
  u.logs.unshift({ date: todayISO(), minutes: mins, at: new Date().toISOString(), hour: new Date().getHours() });
  saveState(STATE);
  toast(`LOG salvo: ${mins} min ‚úì`);
  refreshHeader();
};

// ---------- Init ----------
function init(){
  renderTabs();
  refreshHeader();

  // If no users, go to usuarios
  if(!STATE.activeUserId || !STATE.users[STATE.activeUserId]){
    const first = Object.keys(STATE.users)[0] || null;
    STATE.activeUserId = first;
    saveState(STATE);
  }
  refreshHeader();
  showTab(STATE.activeUserId ? "dashboard" : "usuarios");
  updateMini();
}

init();


// ==========================
// Coach Inteligente (aprende com comportamento)
// - 100% offline
// - stats por usu√°rio (u.coach)
// - integrado ao Dashboard (card fixo)
// ==========================


function coachEnsure(u){
  if(!u.coach) u.coach = { stats:{}, history:[], lastSuggestionId:null, swapIndex:0 };
  if(!u.coach.stats) u.coach.stats = {};
  if(!Array.isArray(u.coach.history)) u.coach.history = [];
  if(typeof u.coach.swapIndex!=="number") u.coach.swapIndex = 0;
}

function coachStat(u, id){
  coachEnsure(u);
  if(!u.coach.stats[id]) u.coach.stats[id] = { shown:0, clicked:0, dismissed:0, lastAt:null };
  return u.coach.stats[id];
}

function coachLog(u, type, actionId, meta={}){
  coachEnsure(u);
  u.coach.history.push({ at: new Date().toISOString(), type, actionId, meta });
  if(u.coach.history.length>200) u.coach.history.splice(0, u.coach.history.length-200);
  saveState(STATE);
}

function coachCTR(s){
  // Laplace smoothing: (clicked+1)/(shown+2)
  return ( (s.clicked||0) + 1 ) / ( (s.shown||0) + 2 );
}


function coachDurLabel(min){
  return `${min} min`;
}

function coachDurOptions(effort){
  if(effort==="low") return [25, 35, 45].filter((v,i,a)=>a.indexOf(v)===i);
  if(effort==="high") return [60, 75, 90].filter((v,i,a)=>a.indexOf(v)===i);
  return [45, 60, 75].filter((v,i,a)=>a.indexOf(v)===i);
}

function coachNowHour(){
  try{ return new Date().getHours(); }catch(e){ return null; }
}

/**
 * Recomenda√ß√£o de dura√ß√£o do bloco (aprende por usu√°rio).
 * - usa stats por dura√ß√£o: id "dur:<min>"
 * - considera pico de produtividade (se existir) para preferir blocos maiores no pico
 */
function coachRecommendBlock(u, effort="medium"){
  coachEnsure(u);
  const opts = coachDurOptions(effort);
  if(!opts.length) return { min: 45, label: "45 min" };

  const peak = coachBestHour(u); // {hour, confidence}
  const nowH = coachNowHour();

  let best = opts[0], bestScore = -1;
  for(const m of opts){
    const s = coachStat(u, "dur:"+m);
    const ctr = coachCTR(s); // 0..1
    let score = 0.70*ctr;

    // b√¥nus de pico: no hor√°rio prov√°vel (¬±1h), favorece blocos maiores conforme confian√ßa
    if(peak && peak.hour!==null && nowH!==null){
      const dist = Math.min(Math.abs(nowH-peak.hour), 24-Math.abs(nowH-peak.hour));
      if(dist<=1){
        const conf = clamp(peak.confidence||0, 0, 1);
        score += conf * (m/90) * 0.30;
      } else {
        // fora do pico, penaliza blocos muito longos
        score += (1 - (m/90)) * 0.08;
      }
    }
    // micro-b√¥nus: se usu√°rio vive dismissando, ctr cai; isso j√° reflete no score.
    if(score>bestScore){ bestScore=score; best=m; }
  }
  return { min: best, label: coachDurLabel(best) };
}
function coachActionScore(u, action){
  // baseScore + aprendizado (CTR) + b√¥nus de contexto
  const s = coachStat(u, action.id);
  const ctr = coachCTR(s); // 0..1

  let score = action.baseScore * (0.65 + 0.35*ctr);

  // Se o usu√°rio costuma "n√£o hoje" em a√ß√µes longas, penaliza
  const dismissRate = (s.dismissed||0) / Math.max(1, (s.shown||0));
  if(action.effort==="high") score *= (1 - Math.min(0.25, dismissRate*0.35));

  // Prefer√™ncia por disciplina (aprendida)
  if(action.subject){
    const prefKey = "subj:"+action.subject;
    const ps = coachStat(u, prefKey);
    score *= (0.85 + 0.30*coachCTR(ps));
  }

  return score;
}

function coachBuildActions(u, plan, rev, cov, mins7, st){
  const phase = plan?.phase || "BASE";
  const covEntries = Object.entries(cov||{});
  const weak = covEntries
    .map(([subject, obj])=>({ subject, pct: Number(obj.pct||0), consolidated: Number(obj.consolidated||0), total: Number(obj.total||0) }))
    .sort((a,b)=>a.pct-b.pct);

  const weakUnder30 = weak.find(x=>x.pct<=30);

  const actions = [];
  const recLow = coachRecommendBlock(u, "low");
  const recMed = coachRecommendBlock(u, "medium");
  const recHigh = coachRecommendBlock(u, "high");


  // 1) Revis√µes vencidas
  if(rev?.due>0){
    actions.push({
      id:"overdue_reviews",
      title:`Zerar revis√µes vencidas (${rev.due})`,
      why:`No modo B, sem revis√£o completa (7/15/30) n√£o entra em Cobertura Real. Limpar vencidas destrava seu progresso.`,
      next:`Abrir Revis√£o`,
      subject:null,
      tab:"caderno",
      baseScore: 100 + rev.due*2,
      effort:"medium"
    });
  } else if(rev?.upcoming7>0){
    actions.push({
      id:"upcoming_reviews",
      title:`Antecipar revis√µes (pr√≥x. 7 dias: ${rev.upcoming7})`,
      why:`Voc√™ est√° limpo(a) de vencidas. Antecipar reduz risco e mant√©m consist√™ncia sem ‚Äúd√≠vida cognitiva‚Äù.`,
      next:`Ver pr√≥ximas`,
      subject:null,
      tab:"caderno",
      baseScore: 72 + rev.upcoming7,
      effort:"low"
    });
  }

  // 2) Disciplina fraca (<30%)
  if(weakUnder30){
    actions.push({
      id:"weak_subject",
      title:`Atacar disciplina fraca: ${weakUnder30.subject} (${weakUnder30.pct}%)`,
      why:`Abaixo de 30% voc√™ perde pontos ‚Äúbaratos‚Äù. Meta de hoje: 1 t√≥pico + quest√µes para gerar erro √∫til + iniciar 7/15/30.`,
      next:`Ir ao Cronograma`,
      subject: weakUnder30.subject,
      tab:"cronograma",
      focusSubject: weakUnder30.subject,
      baseScore: 88 + (30-weakUnder30.pct),
      effort:"high"
    });
  }

  // 3) Streak
  if(st<=0){
    actions.push({
      id:"streak_rescue",
      title:`Resgatar streak hoje (sess√£o curta)`,
      why:`Fa√ßa ${recLow.label} + 5 quest√µes. (O Coach aprende o bloco que voc√™ realmente executa.)`,
      next:`Ir para Hoje`,
      subject:null,
      tab:"hoje",
      baseScore: 76,
      blockMin: recLow.min,
      effort:"low"
    });
  } else if(st>=7){
    actions.push({
      id:"streak_upgrade",
      title:`Streak ${st}d ‚Äî suba a qualidade`,
      why:`Agora o gargalo n√£o √© tempo: √© ‚Äúerro + revis√£o‚Äù. Fa√ßa bloco de quest√µes e registre erros no Caderno.`,
      next:`Registrar erro/quest√µes`,
      subject:null,
      tab:"caderno",
      baseScore: 52,
      effort:"medium"
    });
  }

  // 4) Volume 7 dias vs meta
  const goal = Number(u.weeklyGoalMin||0);
  if(goal>0 && mins7 < Math.round(goal*0.35)){
    actions.push({
      id:"volume_boost",
      title:`Baixo volume (7d ${mins7}m / meta ${goal}m)`,
      why:`Voc√™ est√° abaixo de 35% da meta semanal. Hoje: 1 bloco de ${recMed.label} para ganhar tra√ß√£o.`,
      next:`Iniciar hoje`,
      subject:null,
      tab:"hoje",
      baseScore: 58,
      blockMin: recMed.min,
      effort:"high"
    });
  }

  // 5) A√ß√£o guiada pela fase (curta e √∫til)
  if(phase==="CONSOLIDA√á√ÉO"){
    actions.push({
      id:"phase_consolidation",
      title:`Fase CONSOLIDA√á√ÉO: revis√£o + quest√µes`,
      why:`Aqui voc√™ ‚Äúcolhe‚Äù pontos r√°pido: limpar revis√µes e manter volume de quest√µes para consolidar mem√≥ria.`,
      next:`Abrir Revis√£o`,
      subject:null,
      tab:"caderno",
      baseScore: 44,
      effort:"medium"
    });
  } else if(phase==="APROFUNDAMENTO"){
    actions.push({
      id:"phase_deepen",
      title:`Fase APROFUNDAMENTO: 1 t√≥pico + 15 quest√µes`,
      why:`Aprofunde um t√≥pico e imediatamente fa√ßa quest√µes. Erro √∫til hoje vira Cobertura Real depois do 7/15/30.`,
      next:`Ver plano`,
      subject:null,
      tab:"hoje",
      baseScore: 40,
      effort:"high"
    });
  } else {
    actions.push({
      id:"phase_base",
      title:`Fase BASE: gerar erros intencionais (quest√µes f√°ceis)`,
      why:`No modo B, estudar sem erro n√£o conta. Fa√ßa quest√µes ‚Äúde base‚Äù, capture erros e mande para revis√£o.`,
      next:`Abrir Hoje`,
      subject:null,
      tab:"hoje",
      baseScore: 42,
      effort:"medium"
    });
  }

  return actions;
}

function coachPick(u, actions){
  // registra 'shown' no top 1 (e tamb√©m no subject-pref se tiver)
  if(!actions.length) return null;

  // score
  const scored = actions.map(a=>({ a, score: coachActionScore(u, a) }))
                        .sort((x,y)=>y.score-x.score);

  return scored;
}

function coachSetRiskBadge(rev, weakPct){
  const due = Number(rev?.due||0);
  let risk = 15;
  if(due>0) risk = 70 + Math.min(30, due*6);
  else if(weakPct<=30) risk = 45;
  else risk = 20;
  return clamp(risk, 0, 100);
}


// ---------- Coach: aprende hor√°rio de maior produtividade ----------
function coachBestHour(u){
  const logs = Array.isArray(u.logs) ? u.logs : [];
  // usa somente logs com hour (novos). fallback: se tiver at, extrai.
  const buckets = Array(24).fill(0);
  let total = 0;

  for(const l of logs){
    const mins = Number(l.minutes||0);
    if(!mins) continue;
    let h = (typeof l.hour === "number") ? l.hour : null;
    if(h===null && l.at){
      const d = new Date(l.at);
      if(!isNaN(d)) h = d.getHours();
    }
    if(h===null) continue;
    buckets[h] += mins;
    total += mins;
  }

  if(total < 120){ // pouca evid√™ncia (<2h total com hora)
    return { hour: null, confidence: 0, buckets, total };
  }

  let bestH = 0, bestV = -1;
  for(let h=0; h<24; h++){
    if(buckets[h] > bestV){ bestV = buckets[h]; bestH = h; }
  }
  const confidence = clamp(bestV / Math.max(1,total), 0, 1);
  return { hour: bestH, confidence, buckets, total };
}

function coachHourLabel(h){
  if(h===null || h===undefined) return "‚Äî";
  const hh = String(h).padStart(2,"0");
  return `${hh}:00‚Äì${hh}:59`;
}

// ---------- Meta adaptativa (sobe/desce conforme execu√ß√£o) ----------
function coachEnsureGoalPolicy(u){
  if(!u.goalPolicy) u.goalPolicy = { lastAdjustWeek: null, lastDelta: 0 };
  if(typeof u.goalPolicy.lastDelta !== "number") u.goalPolicy.lastDelta = 0;
}

function weekKeyISO(dateISO){
  // YYYY-WW (ISO simples)
  const d = new Date(dateISO+"T00:00:00");
  const t = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
  // quinta-feira define a semana ISO
  const day = t.getUTCDay() || 7;
  t.setUTCDate(t.getUTCDate() + 4 - day);
  const yearStart = new Date(Date.UTC(t.getUTCFullYear(),0,1));
  const weekNo = Math.ceil((((t - yearStart) / 86400000) + 1) / 7);
  return `${t.getUTCFullYear()}-W${String(weekNo).padStart(2,"0")}`;
}

function minutesInWeek(u, anyDateISO){
  const d = new Date(anyDateISO+"T00:00:00");
  // acha segunda da semana ISO
  const day = (d.getDay()||7); // 1..7
  const monday = new Date(d);
  monday.setDate(d.getDate() - (day-1));
  const sunday = new Date(monday); sunday.setDate(monday.getDate()+6);

  const startISO = monday.toISOString().slice(0,10);
  const endISO = sunday.toISOString().slice(0,10);

  return (u.logs||[]).filter(x=>x.date>=startISO && x.date<=endISO).reduce((s,x)=>s+(Number(x.minutes)||0),0);
}

function roundTo30(n){ return Math.round(n/30)*30; }

function coachAdaptiveGoalUpdate(u){
  coachEnsureGoalPolicy(u);
  const goal = Number(u.weeklyGoalMin||0);
  if(!goal) return { changed:false, newGoal: goal, delta:0, reason:"" };

  const wk = weekKeyISO(todayISO());
  if(u.goalPolicy.lastAdjustWeek === wk) return { changed:false, newGoal: goal, delta:0, reason:"" };

  // ajusta usando semana anterior (mais est√°vel)
  const prev = addDaysISO(todayISO(), -7);
  const prevMin = minutesInWeek(u, prev);

  const ratio = prevMin / Math.max(1, goal); // >1 = bateu
  let newGoal = goal;
  let delta = 0;
  let reason = "";

  if(ratio >= 1.10){
    newGoal = roundTo30(goal * 1.10);
    delta = newGoal - goal;
    reason = "Voc√™ passou de 110% da meta na semana passada. Subindo a meta em 10%.";
  } else if(ratio <= 0.60){
    newGoal = roundTo30(goal * 0.90);
    delta = newGoal - goal;
    reason = "Voc√™ ficou abaixo de 60% da meta na semana passada. Ajustando para uma meta mais execut√°vel (-10%).";
  }

  newGoal = clamp(newGoal, 600, 6000);

  if(newGoal !== goal){
    u.weeklyGoalMin = newGoal;
    u.goalPolicy.lastAdjustWeek = wk;
    u.goalPolicy.lastDelta = delta;
    saveState(STATE);
    return { changed:true, newGoal, delta, reason, ratio, prevMin };
  }

  u.goalPolicy.lastAdjustWeek = wk;
  u.goalPolicy.lastDelta = 0;
  saveState(STATE);
  return { changed:false, newGoal: goal, delta:0, reason:"", ratio, prevMin };
}

// ---------- Miss√£o do Dia (autom√°tica) ----------
function coachBuildMission(u, plan, rev, cov, primaryPick){
  const phase = plan?.phase || "BASE";
  const steps = [];

  // 1) se vencidas, sempre primeiro
  if(rev?.due>0){
    steps.push({ id:"m_overdue", label:`Revisar itens vencidos (${rev.due})`, tab:"caderno", hint:"Marque revisado para avan√ßar 7/15/30." });
  }

  // 2) foco em disciplina fraca (<30%) se existir
  const weak = Object.entries(cov||{})
    .map(([subject,obj])=>({subject, pct:Number(obj.pct||0)}))
    .sort((a,b)=>a.pct-b.pct)[0];

  if(weak && weak.pct<=30){
    steps.push({ id:"m_weak", label:`Estudar 1 t√≥pico de ${weak.subject} + gerar erro`, tab:"cronograma", hint:"Fa√ßa 10‚Äì15 quest√µes e registre o erro." , focusSubject: weak.subject });
    steps.push({ id:"m_log_error", label:`Registrar erro no Caderno (para virar revis√£o)`, tab:"caderno", hint:"Tudo que entra no Caderno de Erros vira revis√£o automaticamente." });
  } else {
    // fallback: seguir o dia do cronograma
    const today = (plan?.days||[])[0];
    if(today){
      steps.push({ id:"m_plan", label:`Cronograma de hoje: ${today.subject}`, tab:"hoje", hint: today.topic || "" });
      steps.push({ id:"m_questions", label:`Fazer quest√µes do t√≥pico e registrar erros`, tab:"caderno", hint:"Modo B exige erro + 7/15/30 para contar progresso." });
    } else {
      steps.push({ id:"m_generic", label:`Sess√£o curta + quest√µes`, tab:"hoje", hint:`Bloco recomendado: ${coachRecommendBlock(u,"low").label} + 5‚Äì10 quest√µes.` });
    }
  }

  // 2.5) Bloco de foco recomendado (aprende + considera pico)
  const effortByPhase = (phase==="APROFUNDAMENTO") ? "high" : (phase==="CONSOLIDA√á√ÉO" ? "medium" : "low");
  const rec = coachRecommendBlock(u, effortByPhase);
  steps.push({ id:"m_focus_block", label:`Bloco de foco: ${rec.label}`, tab:"cronometro", blockMin: rec.min, hint:"Use o cron√¥metro e depois salve como LOG (isso alimenta o Coach)." });


  // 3) fase d√° o ‚Äútom‚Äù final
  if(phase === "CONSOLIDA√á√ÉO"){
    steps.push({ id:"m_consolid", label:"Fechar o dia limpando pr√≥ximas revis√µes", tab:"caderno", hint:"Antecipe pr√≥ximas 7 dias se estiver leve." });
  }

  // limita para UX
  const uniq = [];
  const seen = new Set();
  for(const s of steps){
    if(seen.has(s.id)) continue;
    seen.add(s.id);
    uniq.push(s);
  }
  return uniq.slice(0,5);
}

function coachRenderMission(u, plan, rev, cov, pick){
  const metaEl = $("#dashMissionMeta");
  const listEl = $("#dashMissionList");
  const applyBtn = $("#dashMissionApply");
  if(!metaEl || !listEl || !applyBtn) return;

  // meta adaptativa (1x por semana)
  const g = coachAdaptiveGoalUpdate(u);

  // hor√°rio de pico
  const peak = coachBestHour(u);
  const peakTxt = peak.hour===null ? "Sem dados de hor√°rio ainda (salve LOGs pelo cron√¥metro ou pelo Hoje)." :
    `Seu pico prov√°vel: ${coachHourLabel(peak.hour)} (conf. ${Math.round(peak.confidence*100)}%).`;

  const goalTxt = g.changed ? (g.delta>0 ? `Meta adaptativa: +${g.delta}m (nova: ${g.newGoal}m).` : `Meta adaptativa: ${g.delta}m (nova: ${g.newGoal}m).`) : `Meta semanal: ${u.weeklyGoalMin||0}m.`;

    const recNow = coachRecommendBlock(u, (plan?.phase==="APROFUNDAMENTO")?"high":(plan?.phase==="CONSOLIDA√á√ÉO")?"medium":"low");
  metaEl.textContent = `${peakTxt} ${goalTxt} Bloco recomendado agora: ${recNow.label}.`;

  const steps = coachBuildMission(u, plan, rev, cov, pick);
  listEl.innerHTML = steps.map((s, i)=>`
    <div class="p-3 rounded-2xl bg-sky-50/50 border border-sky-100 flex items-start justify-between gap-3">
      <div>
        <div class="text-sm font-semibold text-slate-900">${i+1}. ${escapeHtml(s.label)}</div>
        <div class="text-xs text-slate-600 mt-0.5">${escapeHtml(s.hint||"")}</div>
      </div>
      <button class="px-3 py-2 rounded-xl bg-white border border-sky-200 text-slate-700 text-xs lift" data-mstep="${i}">Abrir</button>
    </div>
  `).join("");

  listEl.querySelectorAll("[data-mstep]").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      const idx = Number(btn.getAttribute("data-mstep"));
      const s = steps[idx];
      if(s.tab==="cronometro" && s.blockMin){ startFocusBlock(s.blockMin); }
      else { showTab(s.tab || "dashboard"); }
      if(s.focusSubject && typeof focusSubjectInCronograma==="function"){
        setTimeout(()=>focusSubjectInCronograma(s.focusSubject), 60);
      }
      coachLog(u, "mission_open", s.id, { tab:s.tab||null });
    });
  });

  applyBtn.onclick = ()=>{
    // aplica o 1¬∫ passo automaticamente
    const first = steps[0];
    toast("Miss√£o aplicada ‚úì");
    coachLog(u, "mission_apply", "mission", { first:first?.id||null });
    if(first?.tab==="cronometro" && first.blockMin){ startFocusBlock(first.blockMin); }
    else if(first?.tab) showTab(first.tab);
    if(first?.focusSubject && typeof focusSubjectInCronograma==="function"){
      setTimeout(()=>focusSubjectInCronograma(first.focusSubject), 60);
    }
  };
}

function coachRenderDashboard(u, plan, rev, cov, mins7, st){
  // Pode ser chamado mesmo fora do dashboard; s√≥ renderiza se elementos existirem
  const elTitle = $("#dashCoachTitle");
  if(!elTitle) return;

  coachEnsure(u);

  const actions = coachBuildActions(u, plan, rev, cov, mins7, st);
  const scored = coachPick(u, actions);
  if(!scored || !scored.length){
    elTitle.textContent = "Tudo em dia ‚úì";
    $("#dashCoachWhy").textContent = "Sem urg√™ncias agora. Siga o cronograma e mantenha quest√µes.";
    $("#dashCoachFocus").textContent = "Consist√™ncia";
    $("#dashCoachNext").textContent = "Manter ritmo";
    return;
  }

  // Permite "Trocar": usa swapIndex para pegar o N-√©simo da lista
  const idx = u.coach.swapIndex % Math.min(scored.length, 5);
  const pick = scored[idx].a;

  // contabiliza shown (uma vez por render, por pick)
  const s = coachStat(u, pick.id);
  s.shown += 1;
  s.lastAt = new Date().toISOString();
  if(pick.subject){
    const ps = coachStat(u, "subj:"+pick.subject);
    ps.shown += 1;
    ps.lastAt = s.lastAt;
  }
  if(pick.blockMin){
    const ds = coachStat(u, "dur:"+pick.blockMin);
    ds.shown += 1;
    ds.lastAt = s.lastAt;
  }
  saveState(STATE);

  // render
  elTitle.textContent = pick.title;
  $("#dashCoachWhy").textContent = pick.why;
  $("#dashCoachFocus").textContent = pick.subject ? pick.subject : plan?.phase || "‚Äî";
  $("#dashCoachNext").textContent = pick.next;

  // Risk badge
  const weakPct = Math.min(...Object.values(cov||{}).map(x=>Number(x.pct||100)), 100);
  const risk = coachSetRiskBadge(rev, weakPct);
  const riskEl = $("#dashCoachRiskBadge");
  if(riskEl){
    const label = risk>=70 ? "ALTO" : risk>=40 ? "M√âDIO" : "BAIXO";
    riskEl.innerHTML = `Risco <b>${label}</b>`;
  }

  // actions
  const btnPrimary = $("#dashCoachPrimary");
  const btnSwap = $("#dashCoachSwap");
  const btnDismiss = $("#dashCoachDismiss");

  if(btnPrimary){
    btnPrimary.onclick = ()=>{
      const stt = coachStat(u, pick.id);
      stt.clicked += 1;
      stt.lastAt = new Date().toISOString();
      if(pick.subject){
        const ps = coachStat(u, "subj:"+pick.subject);
        ps.clicked += 1;
        ps.lastAt = stt.lastAt;
      }
      if(pick.blockMin){
        const ds = coachStat(u, "dur:"+pick.blockMin);
        ds.clicked += 1;
        ds.lastAt = stt.lastAt;
      }
      coachLog(u, "click", pick.id, { tab: pick.tab, subject: pick.subject||null });
      saveState(STATE);
      toast("Coach: a√ß√£o aplicada ‚úì");
      if(pick.tab==="cronometro" && pick.blockMin){ startFocusBlock(pick.blockMin); }
      else { showTab(pick.tab || "dashboard"); }
      // se for cronograma, tenta rolar/focar (se existir fun√ß√£o)
      if(pick.focusSubject && typeof focusSubjectInCronograma==="function"){
        setTimeout(()=>focusSubjectInCronograma(pick.focusSubject), 50);
      }
    };
  }

  if(btnSwap){
    btnSwap.onclick = ()=>{
      u.coach.swapIndex = (u.coach.swapIndex||0) + 1;
      coachLog(u, "swap", pick.id);
      saveState(STATE);
      coachRenderDashboard(u, plan, rev, cov, mins7, st);
    };
  }

  if(btnDismiss){
    btnDismiss.onclick = ()=>{
      const stt = coachStat(u, pick.id);
      stt.dismissed += 1;
      stt.lastAt = new Date().toISOString();
      if(pick.blockMin){
        const ds = coachStat(u, "dur:"+pick.blockMin);
        ds.dismissed += 1;
        ds.lastAt = stt.lastAt;
      }
      coachLog(u, "dismiss", pick.id);
      // avan√ßa para pr√≥xima sugest√£o
      u.coach.swapIndex = (u.coach.swapIndex||0) + 1;
      saveState(STATE);
      toast("Ok ‚Äî ajustei o Coach.");
      coachRenderDashboard(u, plan, rev, cov, mins7, st);
    };
  }
  // Miss√£o do Dia
  coachRenderMission(u, plan, rev, cov, pick);
}



// ==========================
// Coach Inteligente (aprende com comportamento)
// - 100% offline
// - stats por usu√°rio (u.coach)
// - integrado ao Dashboard (card fixo)
// ==========================

function coachEnsure(u){
  if(!u.coach) u.coach = { stats:{}, history:[], lastSuggestionId:null, swapIndex:0 };
  if(!u.coach.stats) u.coach.stats = {};
  if(!Array.isArray(u.coach.history)) u.coach.history = [];
  if(typeof u.coach.swapIndex!=="number") u.coach.swapIndex = 0;
}

function coachStat(u, id){
  coachEnsure(u);
  if(!u.coach.stats[id]) u.coach.stats[id] = { shown:0, clicked:0, dismissed:0, lastAt:null };
  return u.coach.stats[id];
}

function coachLog(u, type, actionId, meta={}){
  coachEnsure(u);
  u.coach.history.push({ at: new Date().toISOString(), type, actionId, meta });
  if(u.coach.history.length>200) u.coach.history.splice(0, u.coach.history.length-200);
  saveState(STATE);
}

function coachCTR(s){
  // Laplace smoothing: (clicked+1)/(shown+2)
  return ( (s.clicked||0) + 1 ) / ( (s.shown||0) + 2 );
}

function coachActionScore(u, action){
  // baseScore + aprendizado (CTR) + b√¥nus de contexto
  const s = coachStat(u, action.id);
  const ctr = coachCTR(s); // 0..1

  let score = action.baseScore * (0.65 + 0.35*ctr);

  // Se o usu√°rio costuma "n√£o hoje" em a√ß√µes longas, penaliza
  const dismissRate = (s.dismissed||0) / Math.max(1, (s.shown||0));
  if(action.effort==="high") score *= (1 - Math.min(0.25, dismissRate*0.35));

  // Prefer√™ncia por disciplina (aprendida)
  if(action.subject){
    const prefKey = "subj:"+action.subject;
    const ps = coachStat(u, prefKey);
    score *= (0.85 + 0.30*coachCTR(ps));
  }

  return score;
}

function coachBuildActions(u, plan, rev, cov, mins7, st){
  const phase = plan?.phase || "BASE";
  const covEntries = Object.entries(cov||{});
  const weak = covEntries
    .map(([subject, obj])=>({ subject, pct: Number(obj.pct||0), consolidated: Number(obj.consolidated||0), total: Number(obj.total||0) }))
    .sort((a,b)=>a.pct-b.pct);

  const weakUnder30 = weak.find(x=>x.pct<=30);

  const actions = [];

  // 1) Revis√µes vencidas
  if(rev?.due>0){
    actions.push({
      id:"overdue_reviews",
      title:`Zerar revis√µes vencidas (${rev.due})`,
      why:`No modo B, sem revis√£o completa (7/15/30) n√£o entra em Cobertura Real. Limpar vencidas destrava seu progresso.`,
      next:`Abrir Revis√£o`,
      subject:null,
      tab:"caderno",
      baseScore: 100 + rev.due*2,
      effort:"medium"
    });
  } else if(rev?.upcoming7>0){
    actions.push({
      id:"upcoming_reviews",
      title:`Antecipar revis√µes (pr√≥x. 7 dias: ${rev.upcoming7})`,
      why:`Voc√™ est√° limpo(a) de vencidas. Antecipar reduz risco e mant√©m consist√™ncia sem ‚Äúd√≠vida cognitiva‚Äù.`,
      next:`Ver pr√≥ximas`,
      subject:null,
      tab:"caderno",
      baseScore: 72 + rev.upcoming7,
      effort:"low"
    });
  }

  // 2) Disciplina fraca (<30%)
  if(weakUnder30){
    actions.push({
      id:"weak_subject",
      title:`Atacar disciplina fraca: ${weakUnder30.subject} (${weakUnder30.pct}%)`,
      why:`Abaixo de 30% voc√™ perde pontos ‚Äúbaratos‚Äù. Meta de hoje: 1 t√≥pico + quest√µes para gerar erro √∫til + iniciar 7/15/30.`,
      next:`Ir ao Cronograma`,
      subject: weakUnder30.subject,
      tab:"cronograma",
      focusSubject: weakUnder30.subject,
      baseScore: 88 + (30-weakUnder30.pct),
      effort:"high"
    });
  }

  // 3) Streak
  if(st<=0){
    actions.push({
      id:"streak_rescue",
      title:`Resgatar streak hoje (sess√£o curta)`,
      why:`Fa√ßa ${recLow.label} + 5 quest√µes. (O Coach aprende o bloco que voc√™ realmente executa.)`,
      next:`Ir para Hoje`,
      subject:null,
      tab:"hoje",
      baseScore: 76,
      blockMin: recLow.min,
      effort:"low"
    });
  } else if(st>=7){
    actions.push({
      id:"streak_upgrade",
      title:`Streak ${st}d ‚Äî suba a qualidade`,
      why:`Agora o gargalo n√£o √© tempo: √© ‚Äúerro + revis√£o‚Äù. Fa√ßa bloco de quest√µes e registre erros no Caderno.`,
      next:`Registrar erro/quest√µes`,
      subject:null,
      tab:"caderno",
      baseScore: 52,
      effort:"medium"
    });
  }

  // 4) Volume 7 dias vs meta
  const goal = Number(u.weeklyGoalMin||0);
  if(goal>0 && mins7 < Math.round(goal*0.35)){
    actions.push({
      id:"volume_boost",
      title:`Baixo volume (7d ${mins7}m / meta ${goal}m)`,
      why:`Voc√™ est√° abaixo de 35% da meta semanal. Hoje: 1 bloco de ${recMed.label} para ganhar tra√ß√£o.`,
      next:`Iniciar hoje`,
      subject:null,
      tab:"hoje",
      baseScore: 58,
      blockMin: recMed.min,
      effort:"high"
    });
  }

  // 5) A√ß√£o guiada pela fase (curta e √∫til)
  if(phase==="CONSOLIDA√á√ÉO"){
    actions.push({
      id:"phase_consolidation",
      title:`Fase CONSOLIDA√á√ÉO: revis√£o + quest√µes`,
      why:`Aqui voc√™ ‚Äúcolhe‚Äù pontos r√°pido: limpar revis√µes e manter volume de quest√µes para consolidar mem√≥ria.`,
      next:`Abrir Revis√£o`,
      subject:null,
      tab:"caderno",
      baseScore: 44,
      effort:"medium"
    });
  } else if(phase==="APROFUNDAMENTO"){
    actions.push({
      id:"phase_deepen",
      title:`Fase APROFUNDAMENTO: 1 t√≥pico + 15 quest√µes`,
      why:`Aprofunde um t√≥pico e imediatamente fa√ßa quest√µes. Erro √∫til hoje vira Cobertura Real depois do 7/15/30.`,
      next:`Ver plano`,
      subject:null,
      tab:"hoje",
      baseScore: 40,
      effort:"high"
    });
  } else {
    actions.push({
      id:"phase_base",
      title:`Fase BASE: gerar erros intencionais (quest√µes f√°ceis)`,
      why:`No modo B, estudar sem erro n√£o conta. Fa√ßa quest√µes ‚Äúde base‚Äù, capture erros e mande para revis√£o.`,
      next:`Abrir Hoje`,
      subject:null,
      tab:"hoje",
      baseScore: 42,
      effort:"medium"
    });
  }

  return actions;
}

function coachPick(u, actions){
  // registra 'shown' no top 1 (e tamb√©m no subject-pref se tiver)
  if(!actions.length) return null;

  // score
  const scored = actions.map(a=>({ a, score: coachActionScore(u, a) }))
                        .sort((x,y)=>y.score-x.score);

  return scored;
}

function coachSetRiskBadge(rev, weakPct){
  const due = Number(rev?.due||0);
  let risk = 15;
  if(due>0) risk = 70 + Math.min(30, due*6);
  else if(weakPct<=30) risk = 45;
  else risk = 20;
  return clamp(risk, 0, 100);
}

function coachRenderDashboard(u, plan, rev, cov, mins7, st){
  // Pode ser chamado mesmo fora do dashboard; s√≥ renderiza se elementos existirem
  const elTitle = $("#dashCoachTitle");
  if(!elTitle) return;

  coachEnsure(u);

  const actions = coachBuildActions(u, plan, rev, cov, mins7, st);
  const scored = coachPick(u, actions);
  if(!scored || !scored.length){
    elTitle.textContent = "Tudo em dia ‚úì";
    $("#dashCoachWhy").textContent = "Sem urg√™ncias agora. Siga o cronograma e mantenha quest√µes.";
    $("#dashCoachFocus").textContent = "Consist√™ncia";
    $("#dashCoachNext").textContent = "Manter ritmo";
    return;
  }

  // Permite "Trocar": usa swapIndex para pegar o N-√©simo da lista
  const idx = u.coach.swapIndex % Math.min(scored.length, 5);
  const pick = scored[idx].a;

  // contabiliza shown (uma vez por render, por pick)
  const s = coachStat(u, pick.id);
  s.shown += 1;
  s.lastAt = new Date().toISOString();
  if(pick.subject){
    const ps = coachStat(u, "subj:"+pick.subject);
    ps.shown += 1;
    ps.lastAt = s.lastAt;
  }
  saveState(STATE);

  // render
  elTitle.textContent = pick.title;
  $("#dashCoachWhy").textContent = pick.why;
  $("#dashCoachFocus").textContent = pick.subject ? pick.subject : plan?.phase || "‚Äî";
  $("#dashCoachNext").textContent = pick.next;

  // Risk badge
  const weakPct = Math.min(...Object.values(cov||{}).map(x=>Number(x.pct||100)), 100);
  const risk = coachSetRiskBadge(rev, weakPct);
  const riskEl = $("#dashCoachRiskBadge");
  if(riskEl){
    const label = risk>=70 ? "ALTO" : risk>=40 ? "M√âDIO" : "BAIXO";
    riskEl.innerHTML = `Risco <b>${label}</b>`;
  }

  // actions
  const btnPrimary = $("#dashCoachPrimary");
  const btnSwap = $("#dashCoachSwap");
  const btnDismiss = $("#dashCoachDismiss");

  if(btnPrimary){
    btnPrimary.onclick = ()=>{
      const stt = coachStat(u, pick.id);
      stt.clicked += 1;
      stt.lastAt = new Date().toISOString();
      if(pick.subject){
        const ps = coachStat(u, "subj:"+pick.subject);
        ps.clicked += 1;
        ps.lastAt = stt.lastAt;
      }
      coachLog(u, "click", pick.id, { tab: pick.tab, subject: pick.subject||null });
      saveState(STATE);
      toast("Coach: a√ß√£o aplicada ‚úì");
      if(pick.tab==="cronometro" && pick.blockMin){ startFocusBlock(pick.blockMin); }
      else { showTab(pick.tab || "dashboard"); }
      // se for cronograma, tenta rolar/focar (se existir fun√ß√£o)
      if(pick.focusSubject && typeof focusSubjectInCronograma==="function"){
        setTimeout(()=>focusSubjectInCronograma(pick.focusSubject), 50);
      }
    };
  }

  if(btnSwap){
    btnSwap.onclick = ()=>{
      u.coach.swapIndex = (u.coach.swapIndex||0) + 1;
      coachLog(u, "swap", pick.id);
      saveState(STATE);
      coachRenderDashboard(u, plan, rev, cov, mins7, st);
    };
  }

  if(btnDismiss){
    btnDismiss.onclick = ()=>{
      const stt = coachStat(u, pick.id);
      stt.dismissed += 1;
      stt.lastAt = new Date().toISOString();
      coachLog(u, "dismiss", pick.id);
      // avan√ßa para pr√≥xima sugest√£o
      u.coach.swapIndex = (u.coach.swapIndex||0) + 1;
      saveState(STATE);
      toast("Ok ‚Äî ajustei o Coach.");
      coachRenderDashboard(u, plan, rev, cov, mins7, st);
    };
  }
}

</script>

</body>
</html>
