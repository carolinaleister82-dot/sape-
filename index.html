<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Estudo OS - Sync</title>
<style>
  body{margin:0;background:#0e1424;color:#fff;font-family:system-ui}
  header{padding:15px;border-bottom:1px solid #222;display:flex;justify-content:space-between;align-items:center}
  button,input,select,textarea{
    background:#18223c;color:#fff;border:1px solid #2a375a;
    border-radius:8px;padding:10px;margin-top:6px;width:100%;
    box-sizing:border-box;
  }
  button{cursor:pointer;width:auto}
  button.primary{background:#3b5bfd;border:1px solid #3b5bfd}
  .wrap{padding:15px;max-width:900px;margin:0 auto}
  .card{background:#141e36;padding:15px;border-radius:12px;margin-bottom:15px;border:1px solid rgba(255,255,255,.08)}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  @media (max-width:720px){.row{grid-template-columns:1fr}}
  .muted{opacity:.8;font-size:13px}
  .error{color:#ffb4b4;white-space:pre-wrap;margin-top:10px}
  .ok{color:#b7ffcf;white-space:pre-wrap;margin-top:10px}
</style>
</head>
<body>

<header>
  <b>Estudo OS (Sync)</b>
  <div style="display:flex;gap:10px;align-items:center;">
    <span id="status" class="muted">offline</span>
    <button id="logoutBtn" style="display:none;" onclick="logout()">Sair</button>
  </div>
</header>

<div class="wrap" id="app"></div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore-compat.js"></script>

<script>
/* ========= COLE AQUI SEU firebaseConfig REAL (do Firebase Console) ========= */
const firebaseConfig = {
  apiKey: "COLE_AQUI",
  authDomain: "COLE_AQUI",
  projectId: "COLE_AQUI",
  storageBucket: "COLE_AQUI",
  messagingSenderId: "COLE_AQUI",
  appId: "COLE_AQUI"
};
/* ======================================================================== */

let auth, db;
let UID = null;
let STATE = null;
let UNSUB = null;

function $(id){ return document.getElementById(id); }
function today(){ return new Date().toISOString().slice(0,10); }

function blankState(){
  return { user:null, tasks:{}, errors:[], cards:[], logs:[] };
}
function stateRef(uid){ return db.doc(`users/${uid}/app/state`); }

function setStatus(txt){
  $("status").textContent = txt;
}

function showMsg(kind, msg){
  const box = $("msg");
  if(!box) return;
  box.className = kind === "error" ? "error" : "ok";
  box.textContent = msg;
}

function renderLogin(){
  $("app").innerHTML = `
    <div class="card">
      <h3>Login</h3>
      <div class="muted">
        ⚠️ Abra este app em <b>http://localhost</b> ou no Firebase Hosting.
        Se abrir como <b>file:///</b>, o Firebase Auth bloqueia.
      </div>
      <div class="row" style="margin-top:10px;">
        <div>
          <label class="muted">Email</label>
          <input id="email" type="email" placeholder="ex.: amigo@email.com" />
        </div>
        <div>
          <label class="muted">Senha</label>
          <input id="pass" type="password" placeholder="mínimo 6 caracteres" />
        </div>
      </div>

      <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:12px;">
        <button class="primary" onclick="login()">Entrar</button>
        <button onclick="register()">Criar conta</button>
      </div>

      <div id="msg" class="muted" style="margin-top:10px;"></div>

      <div class="muted" style="margin-top:10px;">
        Se não funcionar: (1) ative Email/Senha no Firebase Auth, (2) authorized domain = localhost.
      </div>
    </div>
  `;
}

function renderSetup(){
  $("app").innerHTML = `
    <div class="card">
      <h3>Setup</h3>
      <div class="row">
        <div>
          <label class="muted">Seu nome</label>
          <input id="nome" placeholder="Seu nome" />
        </div>
        <div>
          <label class="muted">Cargo</label>
          <select id="cargo">
            <option value="TRT">TRT Analista</option>
            <option value="RFB">Auditor Receita</option>
            <option value="INSS_A">INSS Analista</option>
            <option value="INSS_T">INSS Técnico</option>
          </select>
        </div>
        <div>
          <label class="muted">Data de início</label>
          <input type="date" id="inicio" value="${today()}" />
        </div>
        <div>
          <label class="muted">Meta</label>
          <select id="meta">
            <option value="0.9">90%</option>
            <option value="0.85">85%</option>
          </select>
        </div>
      </div>

      <button class="primary" style="margin-top:12px;" onclick="salvarSetup()">Salvar</button>
      <div id="msg" class="muted" style="margin-top:10px;"></div>
    </div>
  `;
}

function renderHome(){
  const revisoesHoje = STATE.cards.filter(c => (c.due || today()) <= today()).length;
  const erros = STATE.errors.length;

  $("app").innerHTML = `
    <div class="card">
      <h3>Olá, ${STATE.user.nome}</h3>
      <div class="muted">Cargo: <b>${STATE.user.cargo}</b> • Início: ${STATE.user.inicio} • Meta: ${STATE.user.meta}</div>
      <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:12px;">
        <button onclick="renderErros()">Caderno de Erros</button>
        <button class="primary" onclick="renderFlashcards()">Flashcards</button>
      </div>
    </div>

    <div class="card">
      <h3>Resumo</h3>
      <div class="row">
        <div class="card" style="margin:0;background:#10182c;border:none;">
          <div class="muted">Erros</div>
          <div style="font-size:22px;"><b>${erros}</b></div>
        </div>
        <div class="card" style="margin:0;background:#10182c;border:none;">
          <div class="muted">Revisões hoje</div>
          <div style="font-size:22px;"><b>${revisoesHoje}</b></div>
        </div>
      </div>
    </div>
  `;
}

function renderErros(){
  $("app").innerHTML = `
    <div class="card">
      <h3>Novo Erro</h3>
      <label class="muted">Pergunta</label>
      <textarea id="pergunta" rows="3" placeholder="Cole a questão..."></textarea>
      <label class="muted" style="margin-top:8px;display:block;">Resposta correta</label>
      <textarea id="resposta" rows="3" placeholder="Regra / artigo / exceção..."></textarea>

      <button class="primary" style="margin-top:10px;" onclick="salvarErro()">Salvar (gera flashcard)</button>
      <div id="msg" class="muted" style="margin-top:10px;"></div>
    </div>
    <button onclick="renderHome()">Voltar</button>
  `;
}

function renderFlashcards(){
  const queue = STATE.cards.filter(c => (c.due || today()) <= today());
  if(!queue.length){
    $("app").innerHTML = `
      <div class="card"><h3>Nada para revisar hoje ✅</h3></div>
      <button onclick="renderHome()">Voltar</button>
    `;
    return;
  }

  const c = queue[0];
  $("app").innerHTML = `
    <div class="card">
      <h3>Revisão</h3>
      <div class="muted">Due: ${c.due || today()}</div>
      <hr style="border:0;border-top:1px solid rgba(255,255,255,.12);margin:12px 0;">
      <b>Pergunta</b>
      <div style="white-space:pre-wrap;margin-top:6px;">${escapeHTML(c.front)}</div>
      <hr style="border:0;border-top:1px solid rgba(255,255,255,.12);margin:12px 0;">
      <b>Resposta</b>
      <div style="white-space:pre-wrap;margin-top:6px;">${escapeHTML(c.back)}</div>

      <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:12px;">
        <button onclick="avaliar('${c.id}','again')">Again</button>
        <button class="primary" onclick="avaliar('${c.id}','good')">Good</button>
        <button onclick="avaliar('${c.id}','easy')">Easy</button>
      </div>
    </div>
    <button onclick="renderHome()">Voltar</button>
  `;
}

function escapeHTML(s){
  return (s||"").replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;");
}

// ====== ações ======
async function login(){
  showMsg("ok", "Entrando...");
  try{
    await auth.signInWithEmailAndPassword($("email").value.trim(), $("pass").value);
    showMsg("ok", "Logado ✅");
  }catch(e){
    showMsg("error", `Erro ao entrar:\n${e.code}\n${e.message}`);
  }
}
async function register(){
  showMsg("ok", "Criando conta...");
  try{
    await auth.createUserWithEmailAndPassword($("email").value.trim(), $("pass").value);
    showMsg("ok", "Conta criada ✅");
  }catch(e){
    showMsg("error", `Erro ao criar conta:\n${e.code}\n${e.message}\n\nDicas:\n- Senha min. 6\n- Auth Email/Senha habilitado\n- Domínio autorizado (localhost)\n- Não pode ser file:///`);
  }
}
function logout(){ auth.signOut(); }

async function salvarSetup(){
  STATE.user = {
    nome: $("nome").value.trim() || "Usuário",
    cargo: $("cargo").value,
    inicio: $("inicio").value || today(),
    meta: parseFloat($("meta").value || "0.9")
  };
  await save();
  renderHome();
}
async function salvarErro(){
  const pergunta = $("pergunta").value.trim();
  const resposta = $("resposta").value.trim();
  if(!pergunta || !resposta){
    showMsg("error", "Preencha pergunta e resposta correta.");
    return;
  }
  const erro = { id: crypto.randomUUID(), pergunta, resposta, data: today() };
  STATE.errors.push(erro);

  // cria flashcard automaticamente
  STATE.cards.push({
    id: crypto.randomUUID(),
    front: pergunta,
    back: resposta,
    due: today(),
    stability: 1
  });

  await save();
  renderHome();
}

async function avaliar(id, tipo){
  const c = STATE.cards.find(x => x.id === id);
  if(!c) return;

  let mult = 1;
  if(tipo === "again") mult = 0.6;
  if(tipo === "good")  mult = 2.0;
  if(tipo === "easy")  mult = 3.0;

  c.stability = Math.max(1, (c.stability || 1) * mult);

  const days = Math.max(1, Math.round(c.stability));
  c.due = addDays(today(), days);

  await save();
  renderFlashcards();
}

function addDays(date, days){
  const d = new Date(date + "T00:00:00");
  d.setDate(d.getDate() + days);
  return d.toISOString().slice(0,10);
}

async function save(){
  const ref = stateRef(UID);
  await ref.set({ ...STATE, _updatedAt: new Date().toISOString() }, { merge:true });
}

// ===== bootstrap =====
function initFirebase(){
  firebase.initializeApp(firebaseConfig);
  auth = firebase.auth();
  db = firebase.firestore();

  db.enablePersistence({ synchronizeTabs:true }).catch(()=>{});

  auth.onAuthStateChanged(async (user)=>{
    if(!user){
      UID = null;
      STATE = null;
      $("logoutBtn").style.display = "none";
      setStatus("offline");
      renderLogin();
      return;
    }
    UID = user.uid;
    $("logoutBtn").style.display = "inline-block";
    setStatus(navigator.onLine ? "online" : "offline");

    const ref = stateRef(UID);
    const snap = await ref.get();
    if(!snap.exists) await ref.set(blankState());

    if(UNSUB) UNSUB();
    UNSUB = ref.onSnapshot((s)=>{
      STATE = s.data();
      setStatus(s.metadata.fromCache ? "online (cache)" : "online (sync)");
      if(!STATE.user) renderSetup();
      else renderHome();
    });
  });

  window.addEventListener("online", ()=> setStatus("online"));
  window.addEventListener("offline", ()=> setStatus("offline"));
}

try{
  initFirebase();
}catch(e){
  $("app").innerHTML = `
    <div class="card">
      <h3>Erro de configuração</h3>
      <div class="error">${e.message}</div>
      <div class="muted" style="margin-top:10px;">
        Verifique se você colou corretamente o <b>firebaseConfig</b>.
      </div>
    </div>
  `;
}
</script>
</body>
</html>
